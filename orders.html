<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pack & Wrap • Orders</title>
  <link rel="stylesheet" href="styles.css"/>

  <style>
    /* Same topbar & tabs UI as your overview page */
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(17,24,39,.85), rgba(17,24,39,.65));
      border-bottom:1px solid var(--border);
    }
    .brand-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 16px; }
    .brand{
      font-weight:900; letter-spacing:.3px; font-size:18px;
      background:linear-gradient(90deg,#fff,#d8b4fe,#f9a8d4);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow:0 2px 8px rgba(0,0,0,.25);
    }
    .chip{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.06); }
    .tabs-wrap{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:0 8px 10px 8px; }
    .nav-toggle{ display:none; border:1px solid var(--border); background:rgba(255,255,255,.06); padding:8px 12px; border-radius:10px; cursor:pointer; }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; padding:6px; border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,.04); }
    .tabs a{ text-decoration:none; padding:8px 12px; border-radius:10px; color:inherit; transition:background .15s ease, color .15s ease, transform .15s ease; }
    .tabs a:hover{ background:rgba(255,255,255,.08); transform:translateY(-1px); }
    .tabs a[aria-current="page"]{ background:linear-gradient(90deg,#a78bfa22,#f472b622); border:1px solid var(--border); font-weight:700; }
    .tabs .btn.ghost{ margin-left:4px; }
    @media (max-width:760px){
      .nav-toggle{ display:inline-block; }
      .tabs{ display:none; width:100%; flex-direction:column; }
      .tabs.show{ display:flex; }
      .tabs a, .tabs .btn.ghost{ width:100%; text-align:left; }
    }

    /* Orders page layout */
    .page-head{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin:16px 0; }
    .title-wrap{ display:grid; gap:6px; }
    .title-wrap h2{ margin:0; font-size:24px; }
    .title-wrap .sub{ margin:0; color:var(--muted); font-size:13px; }

    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media(max-width:900px){ .grid-2{ grid-template-columns:1fr; } }

    textarea#orderMsg{ min-height:260px; width:100%; resize:vertical; }
    .form .row{ display:grid; grid-template-columns: 160px 1fr; gap:10px; align-items:center; }
    .form .row input, .form .row textarea{ width:100%; }
    .help{ font-size:12px; color:var(--muted); }

    .bookmarklet-block code{
      user-select: all; display:block; padding:10px; border-radius:10px; border:1px solid var(--border); background:rgba(255,255,255,.04);
      overflow:auto; font-size:12px;
    }
  </style>
</head>

<body class="bg-grad" id="page-orders">
  <div class="bg-figurines" aria-hidden="true">
    <span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span>
  </div>

  <!-- Topbar (unchanged UI) -->
  <header class="topbar">
    <header class="topbar">
    <div class="brand-row">
      <span class="brand">Pack &amp; Wrap</span>
      <span class="chip" id="overallProfitChip">Overall 0 TK</span>
    </div>

    <div class="tabs-wrap">
      <button id="navToggle" class="nav-toggle" type="button">☰ Menu</button>
      <nav class="tabs" id="mainTabs">
        <a href="/overview.html"    data-route="overview"   id="tabOverview">Overview</a>
        <a href="/products.html"    data-route="products"   id="tabProducts">Products</a>
        <a href="/investments.html" data-route="investments" id="tabInvestments">Investments</a>
        <a href="/sales.html"       data-route="sales"      id="tabSales">Sales</a>
        <a href="/customers.html"   data-route="customers"  id="tabCustomers">Customers</a>
        <a href="/boost.html"       data-route="boost"      id="tabBoost">Boost</a>
        <a href="/backup.html"      data-route="backup"     id="tabBackup">Backup</a>
        <a href="/orders.html"      data-route="orders"     id="tabOrders" aria-current="page">Orders</a>
        <a class="btn ghost" href="#" id="logoutBtn">Logout</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <div class="page-head">
        <div class="title-wrap">
          <h2>Orders</h2>
          <p class="sub">Paste a confirmation message → we’ll detect Name, Phone, Address, Size, Qty &amp; Total.</p>
        </div>
      </div>

      <div class="grid-2">
        <!-- LEFT: paste -->
        <div class="card">
          <div class="field">
            <label for="orderMsg">Paste confirmation message</label>
            <!-- No placeholder (per your request) -->
            <textarea id="orderMsg"></textarea>
          </div>
          <div class="actions" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
            <button id="btnParse" class="btn primary">Parse</button>
          </div>
          <p class="help">Bangla/English, labeled or unlabeled, multi-line totals supported.</p>
        </div>

        <!-- RIGHT: review/edit -->
        <div class="card">
          <h3 style="margin:0 0 8px;">Review &amp; edit</h3>
          <div class="form vgap" id="reviewForm">
            <div class="row"><label>Name</label>     <input id="fName"/></div>
            <div class="row"><label>Phone</label>    <input id="fPhone"/></div>
            <div class="row"><label>Address</label>  <textarea id="fAddress" rows="3"></textarea></div>
            <div class="row"><label>Size / Spec</label><textarea id="fSize" rows="2"></textarea></div>
            <div class="row"><label>Pieces</label>   <input id="fPieces"   type="number" inputmode="numeric" min="1"/></div>
            <div class="row"><label>Total (COD)</label><input id="fTotal"  type="number" inputmode="decimal"/></div>
          </div>

          <div class="actions" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
            <button id="btnCopyPayload" class="btn">Copy Autofill payload</button>
            <a id="btnOpenSteadfast" class="btn ghost" href="https://www.steadfast.com.bd/user/add-parcel/regular" target="_blank" rel="noopener">Open Steadfast</a>
          </div>

          <div class="bookmarklet-block" style="margin-top:12px;">
            <div class="help" style="margin-bottom:6px;">After opening Steadfast, click the bookmarklet below to fill the form automatically (reads the payload you copied):</div>
            <code id="bmCode"></code>
            <div class="actions" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
              <button id="btnCopyBM" class="btn">Copy Bookmarklet code</button>
              <span class="help">Create a browser bookmark and paste this code into the URL field.</span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- app.js exports the parsing helpers used below -->
  <script type="module">
    import { parseOrderMessage, buildAutofillPayload } from './app.js';

    // ---------- Auth & pretty URLs (unchanged behavior) ----------
    (function(){
      const authed = (sessionStorage.getItem('pw_authed') === '1') || (localStorage.getItem('pw_authed') === '1');
      const uid = sessionStorage.getItem('pw_userId') || localStorage.getItem('pw_userId');
      if(!authed || !uid){
        history.replaceState({}, '', '/login');
        location.replace('index.html');
        return;
      }
      const want = `/${encodeURIComponent(uid)}/orders`;
      if (location.pathname !== want) history.replaceState({}, '', want);

      const nav = document.getElementById('mainTabs');
      nav?.querySelectorAll('a[data-route]').forEach(a=>{
        const route = a.getAttribute('data-route');
        a.setAttribute('href', `/${route}.html`);
        a.addEventListener('click', (e)=>{
          if (a.id === 'logoutBtn') return;
          e.preventDefault();
          history.replaceState({}, '', `/${encodeURIComponent(uid)}/${route}`);
          location.assign(`/${route}.html`);
        });
      });

      // Mobile nav toggle
      document.getElementById('navToggle')?.addEventListener('click', ()=>{
        document.getElementById('mainTabs')?.classList.toggle('show');
      });

      // Logout
      document.getElementById('logoutBtn')?.addEventListener('click', (e)=>{
        e.preventDefault();
        sessionStorage.removeItem('pw_authed');
        sessionStorage.removeItem('pw_userId');
        localStorage.removeItem('pw_authed');
        localStorage.removeItem('pw_userId');
        history.replaceState({}, '', '/login');
        location.replace('index.html');
      });
    })();

    const el = id => document.getElementById(id);
    const msg = el('orderMsg');
    const f = {
      name: el('fName'),
      phone: el('fPhone'),
      address: el('fAddress'),
      size: el('fSize'),
      pieces: el('fPieces'),
      total: el('fTotal'),
    };

    function fillForm(data){
      f.name.value    = data.name || '';
      f.phone.value   = data.phone || '';
      f.address.value = data.address || '';
      f.size.value    = data.size || '';
      f.pieces.value  = data.pieces || '';
      f.total.value   = data.codAmount || '';
    }

    // Parse button
    el('btnParse')?.addEventListener('click', ()=>{
      const data = parseOrderMessage(msg.value || '');
      fillForm(data);
    });

    // Copy payload for the bookmarklet (adds productDetail too)
    el('btnCopyPayload')?.addEventListener('click', async ()=>{
      let base = {};
      try{
        base = JSON.parse(buildAutofillPayload({
          name: f.name.value, phone: f.phone.value, address: f.address.value,
          size: f.size.value, pieces: f.pieces.value, codAmount: f.total.value
        }));
      }catch{ base = {}; }

      const pcsTxt = (f.pieces.value ? ` (${f.pieces.value} pcs)` : '');
      base.productDetail = `${f.size.value || ''}${pcsTxt}`.trim();

      const payload = JSON.stringify(base);
      try{
        await navigator.clipboard.writeText(payload);
        el('btnCopyPayload').textContent = 'Copied ✓';
        setTimeout(()=> el('btnCopyPayload').textContent = 'Copy Autofill payload', 1200);
      }catch(_){
        alert('Could not copy to clipboard. Please copy manually:\n\n' + payload);
      }
    });

    // Bookmarklet code (fills Steadfast fields heuristically)
    const bm =
`javascript:(()=>{async function readClip(){try{return await navigator.clipboard.readText()}catch(e){return prompt('Paste payload (JSON):')||''}}function pick(els,keys){keys=keys.map(k=>k.toLowerCase());for(const el of els){const type=(el.type||'').toLowerCase();const tag=(el.tagName||'').toLowerCase();const ph=(el.getAttribute('placeholder')||'').toLowerCase();const name=(el.getAttribute('name')||'').toLowerCase();const id=(el.id||'').toLowerCase();const lbl=document.querySelector('label[for=\"'+el.id+'\"]');const labtxt=(lbl?lbl.textContent:'').toLowerCase();const near=el.closest('div,td,th,li,section,fieldset');const nearTxt=(near?near.textContent:'').toLowerCase();const hay=[ph,name,id,labtxt,nearTxt].join('|');if(keys.some(k=>hay.includes(k))){if(tag==='input'&&(type==='submit'||type==='button'||type==='checkbox'||type==='radio')) continue;return el}}return null}function setVal(el,val){if(!el) return;el.focus();if(el.tagName==='SELECT'){for(const o of el.options){if((o.value||'').toLowerCase()===String(val).toLowerCase()||o.textContent.toLowerCase().includes(String(val).toLowerCase())){el.value=o.value;break}}}else{el.value=val}el.dispatchEvent(new Event('input',{bubbles:true}));el.dispatchEvent(new Event('change',{bubbles:true}))}async function run(){let t=await readClip();if(!t){alert('No payload provided.');return}let d={};try{d=JSON.parse(t)}catch(e){alert('Invalid payload JSON.');return}const all=[...document.querySelectorAll('input,textarea,select')];const nameEl = pick(all,['name','customer name','receiver','recipient','customer','নাম']);const phoneEl= pick(all,['phone','mobile','customer mobile','receiver mobile','মোবাইল','ফোন']);const addrEl = pick(all,['address','delivery address','customer address','receiver address','ঠিকানা']);const codEl  = pick(all,['cod','cod amount','cash','collection','amount','total','টাকা']);const prodEl = pick(all,['product','details','product details','product brief','item','parcel','description']);setVal(nameEl,d.name||'');setVal(phoneEl,d.phone||'');setVal(addrEl,d.address||'');setVal(codEl,d.codAmount||'');setVal(prodEl,d.productDetail||d.size||'');alert('Filled name/phone/address/amount/product. Please review and submit.')}run()})()`;
    el('bmCode').textContent = bm;
    el('btnCopyBM')?.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(bm); el('btnCopyBM').textContent='Copied ✓'; setTimeout(()=> el('btnCopyBM').textContent='Copy Bookmarklet code', 1200); }
      catch(_){ alert('Copy failed. Select the code block and copy it manually.'); }
    });
  </script>
</body>
</html>
