<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pack & Wrap • Orders</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .page{ max-width:1100px; margin:0 auto; padding:16px; }
    .row{ display:grid; gap:12px; grid-template-columns:1fr 1fr; }
    .card{ padding:14px; border-radius:16px; }
    .muted{ color:var(--muted); }
    .k{ display:grid; gap:8px; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .ok{ color:#86efac; }
    .bad{ color:#fca5a5; }

    .banner{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px;
      border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,.04); margin-bottom:12px; }
    .pill{ border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; }

    textarea{ width:100%; min-height:220px; }

    @media (max-width:860px){
      .row{ grid-template-columns:1fr; }
      textarea{ min-height:180px; }
    }

    /* Topbar (same as Overview) */
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(17,24,39,.85), rgba(17,24,39,.65));
      border-bottom:1px solid var(--border);
    }
    .brand-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 16px; }
    .brand{
      font-weight:900; letter-spacing:.3px; font-size:18px;
      background:linear-gradient(90deg,#fff,#d8b4fe,#f9a8d4);
      -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:0 2px 8px rgba(0,0,0,.25);
    }
    .chip{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.06); }
    .tabs-wrap{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:0 8px 10px 8px; }
    .nav-toggle{ display:none; border:1px solid var(--border); background:rgba(255,255,255,.06); padding:8px 12px; border-radius:10px; cursor:pointer; }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; padding:6px; border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,.04); }
    .tabs a{ text-decoration:none; padding:8px 12px; border-radius:10px; color:inherit; transition:background .15s ease, color .15s ease, transform .15s ease; }
    .tabs a:hover{ background:rgba(255,255,255,.08); transform:translateY(-1px); }
    .tabs a[aria-current="page"]{ background:linear-gradient(90deg,#a78bfa22,#f472b622); border:1px solid var(--border); font-weight:700; }
    .tabs .btn.ghost{ margin-left:4px; }
    @media (max-width:760px){ .nav-toggle{ display:inline-block; } .tabs{ display:none; width:100%; flex-direction:column; } .tabs.show{ display:flex; } .tabs a, .tabs .btn.ghost{ width:100%; text-align:left; margin-left:0; } }
  </style>
</head>

<body class="bg-grad" id="page-orders">
  <div class="bg-figurines" aria-hidden="true">
    <span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span>
  </div>

  <!-- NAVBAR (same as Overview; Orders tab added) -->
  <header class="topbar">
    <div class="brand-row">
      <span class="brand">Pack &amp; Wrap</span>
      <span class="chip" id="overallProfitChip">Overall 0 TK</span>
    </div>
    <div class="tabs-wrap">
      <button id="navToggle" class="nav-toggle" type="button">☰ Menu</button>
      <nav class="tabs" id="mainTabs">
        <a href="/overview.html"    data-route="overview"    id="tabOverview">Overview</a>
        <a href="/products.html"    data-route="products"    id="tabProducts">Products</a>
        <a href="/investments.html" data-route="investments" id="tabInvestments">Investments</a>
        <a href="/sales.html"       data-route="sales"       id="tabSales">Sales</a>
        <a href="/customers.html"   data-route="customers"   id="tabCustomers">Customers</a>
        <a href="/boost.html"       data-route="boost"       id="tabBoost">Boost</a>
        <a href="/orders.html"      data-route="orders"      id="tabParcels" aria-current="page">Orders</a>
        <a href="/backup.html"      data-route="backup"      id="tabBackup">Backup</a>
        <a class="btn ghost" href="#" id="logoutBtn">Logout</a>
      </nav>
    </div>
  </header>

  <main class="page container">
    <!-- Connected banner -->
    <div id="connBanner" class="banner" style="display:none">
      <div>
        <strong id="connCompany">Steadfast</strong>
        <span class="muted">• Owner: <span id="connOwner">—</span> • Merchant: <span id="connMerchant">—</span></span>
      </div>
      <div class="actions">
        <button class="btn" id="btnLock">Lock keys</button>
        <button class="btn ghost" id="btnChange">Change keys</button>
      </div>
    </div>

    <!-- Connect / Unlock -->
    <section id="connectView" class="card" style="display:none">
      <h3 style="margin:0 0 8px">Connect Steadfast</h3>
      <p class="muted" style="margin:0 0 8px">
        Use your <strong>API Key</strong> and <strong>Secret Key</strong> from the Steadfast portal (More → API → create key). We’ll encrypt them with your passphrase and store only the ciphertext. 
      </p>
      <div class="k" id="connectForm">
        <label>Company name <input id="fCompany" /></label>
        <label>Owner name <input id="fOwner" /></label>
        <label>Merchant ID (optional) <input id="fMerchant" /></label>
        <label>API Key <input id="fApi" autocomplete="off"/></label>
        <label>Secret Key <input id="fSecret" autocomplete="off"/></label>
        <label>Choose a passphrase (you’ll need this to unlock) <input id="fPass" type="password" /></label>
        <div class="actions">
          <button class="btn primary" id="btnSaveConnect">Save &amp; Connect</button>
        </div>
        <p id="connErr" class="muted bad"></p>
      </div>

      <div class="k" id="unlockForm" style="display:none">
        <label>Enter passphrase to unlock <input id="uPass" type="password"/></label>
        <div class="actions">
          <button class="btn primary" id="btnUnlock">Unlock</button>
          <button class="btn ghost" id="btnReset">Use different keys</button>
        </div>
        <p id="unlockErr" class="muted bad"></p>
      </div>
    </section>

    <!-- Order UI -->
    <section id="ordersView" style="display:none">
      <div class="row">
        <div class="card">
          <h3 style="margin:0 0 8px">Paste confirmation message</h3>
          <textarea id="msg"></textarea>
          <div class="actions" style="margin-top:8px">
            <button class="btn" id="btnParse">Parse</button>
            <button class="btn ghost" id="btnClear">Clear</button>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px">Review &amp; submit</h3>
          <div class="k">
            <label>Name <input id="oName"/></label>
            <label>Phone <input id="oPhone"/></label>
            <label>Address <textarea id="oAddr" style="min-height:90px"></textarea></label>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px">
              <label>Size/spec <input id="oSize"/></label>
              <label>Pieces <input id="oPieces"/></label>
            </div>
            <label>COD amount (tk) <input id="oCod"/></label>
            <label>Note (optional, shown in consignment) <input id="oNote" placeholder="e.g., Leave at gate"/></label>
          </div>

          <div class="actions" style="margin-top:10px">
            <button class="btn primary" id="btnSubmit">Submit to Steadfast</button>
            <span id="submitMsg" class="muted"></span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- App -->
  <script type="module">
    import {
      db, parseOrderMessage, saveSteadfastKeys, hasSteadfastKeys,
      unlockSteadfastKeys, getSteadfastProfile, placeSteadfastOrder,
      bnToEnDigits
    } from './app.js';

    // ---------- Auth & pretty URL ----------
    (function(){
      const authed = (sessionStorage.getItem('pw_authed') === '1') || (localStorage.getItem('pw_authed') === '1');
      const uid = sessionStorage.getItem('pw_userId') || localStorage.getItem('pw_userId');
      if(!authed || !uid){
        history.replaceState({}, '', '/login');
        location.replace('index.html'); return;
      }
      const want = `/${encodeURIComponent(uid)}/orders`;
      if (location.pathname !== want) history.replaceState({}, '', want);

      // navbar pretty routing
      const nav = document.getElementById('mainTabs');
      if (nav){
        nav.querySelectorAll('a[data-route]').forEach(a=>{
          const route = a.getAttribute('data-route');
          a.setAttribute('href', `/${route}.html`);
          a.addEventListener('click', (e)=>{
            if (a.id === 'logoutBtn') return;
            e.preventDefault();
            history.replaceState({}, '', `/${encodeURIComponent(uid)}/${route}`);
            location.assign(`/${route}.html`);
          });
        });
      }

      // mobile nav
      document.getElementById('navToggle')?.addEventListener('click', ()=>{
        document.getElementById('mainTabs')?.classList.toggle('show');
      });

      // logout
      document.getElementById('logoutBtn')?.addEventListener('click', (e)=>{
        e.preventDefault();
        sessionStorage.removeItem('pw_authed'); sessionStorage.removeItem('pw_userId');
        localStorage.removeItem('pw_authed');   localStorage.removeItem('pw_userId');
        history.replaceState({}, '', '/login');
        location.replace('index.html');
      });
    })();

    // ---------- UI wiring ----------
    const uid = sessionStorage.getItem('pw_userId') || localStorage.getItem('pw_userId');
    const connectView = document.getElementById('connectView');
    const connectForm = document.getElementById('connectForm');
    const unlockForm  = document.getElementById('unlockForm');
    const ordersView  = document.getElementById('ordersView');
    const connBanner  = document.getElementById('connBanner');

    async function refreshState(){
      const has = await hasSteadfastKeys(uid);
      const prof = await getSteadfastProfile(uid);
      document.getElementById('connCompany').textContent = prof?.companyName || 'Steadfast';
      document.getElementById('connOwner').textContent   = prof?.ownerName || '—';
      document.getElementById('connMerchant').textContent= prof?.merchantId || '—';

      if (!has){
        // need to connect new keys
        connectView.style.display = '';
        connectForm.style.display = '';
        unlockForm.style.display  = 'none';
        ordersView.style.display  = 'none';
        connBanner.style.display  = 'none';
      } else {
        // have encrypted keys → ask to unlock
        connectView.style.display = '';
        connectForm.style.display = 'none';
        unlockForm.style.display  = '';
        ordersView.style.display  = 'none';
        connBanner.style.display  = 'none';
      }
    }

    // Save & Connect
    document.getElementById('btnSaveConnect')?.addEventListener('click', async ()=>{
      const company  = document.getElementById('fCompany').value.trim();
      const owner    = document.getElementById('fOwner').value.trim();
      const merchant = document.getElementById('fMerchant').value.trim();
      const api      = document.getElementById('fApi').value.trim();
      const secret   = document.getElementById('fSecret').value.trim();
      const pass     = document.getElementById('fPass').value;
      const err      = document.getElementById('connErr');
      err.textContent = '';
      try{
        if (!api || !secret || !pass){ throw new Error('API Key, Secret Key and a passphrase are required.'); }
        await saveSteadfastKeys(uid, pass, { apiKey:api, secretKey:secret }, { companyName: company, ownerName: owner, merchantId: merchant });
        // Immediately try to unlock to confirm passphrase OK
        await unlockSteadfastKeys(uid, pass);
        connectView.style.display = 'none';
        ordersView.style.display  = '';
        connBanner.style.display  = '';
      }catch(e){ err.textContent = e.message || String(e); }
    });

    // Unlock
    document.getElementById('btnUnlock')?.addEventListener('click', async ()=>{
      const pass = document.getElementById('uPass').value;
      const err  = document.getElementById('unlockErr');
      err.textContent = '';
      try{
        await unlockSteadfastKeys(uid, pass);
        sessionStorage.setItem('pw_sf_pass', pass); // keep only in session (not localStorage)
        connectView.style.display = 'none';
        ordersView.style.display  = '';
        connBanner.style.display  = '';
      }catch(e){ err.textContent = 'Wrong passphrase or corrupt keys.'; }
    });

    // Lock keys (forget pass)
    document.getElementById('btnLock')?.addEventListener('click', ()=>{
      sessionStorage.removeItem('pw_sf_pass');
      refreshState();
    });

    // Change keys
    document.getElementById('btnChange')?.addEventListener('click', ()=>{
      sessionStorage.removeItem('pw_sf_pass');
      // show connect form again
      connectView.style.display = '';
      connectForm.style.display = '';
      unlockForm.style.display  = 'none';
      ordersView.style.display  = 'none';
      connBanner.style.display  = 'none';
    });

    // Parse message
    document.getElementById('btnParse')?.addEventListener('click', ()=>{
      const m = document.getElementById('msg').value;
      const p = parseOrderMessage(m);
      document.getElementById('oName').value   = p.name;
      document.getElementById('oPhone').value  = p.phone;
      document.getElementById('oAddr').value   = p.address;
      document.getElementById('oSize').value   = p.size;
      document.getElementById('oPieces').value = p.pieces;
      document.getElementById('oCod').value    = p.codAmount;
    });

    document.getElementById('btnClear')?.addEventListener('click', ()=>{
      document.getElementById('msg').value = '';
    });

    // Submit to Steadfast via proxy
    document.getElementById('btnSubmit')?.addEventListener('click', async ()=>{
      const name  = document.getElementById('oName').value.trim();
      const phone = document.getElementById('oPhone').value.trim();
      const addr  = document.getElementById('oAddr').value.trim();
      const size  = document.getElementById('oSize').value.trim();
      const pcs   = document.getElementById('oPieces').value.trim();
      const cod   = Number((document.getElementById('oCod').value||'').toString().replace(/[^\d.]/g,''));
      const note  = document.getElementById('oNote').value.trim();
      const pass  = sessionStorage.getItem('pw_sf_pass') || prompt('Enter passphrase to unlock your keys');

      const out = document.getElementById('submitMsg');
      out.textContent = '';

      if (!name || !phone || !addr || !cod){
        out.textContent = 'Please fill Name, Phone, Address, and COD.'; return;
      }

      // Build Steadfast order payload (per official package fields)
      const order = {
        invoice: 'web-' + Date.now(),
        recipient_name: name,
        recipient_phone: bnToEnDigits(phone),
        recipient_address: addr,
        cod_amount: cod,
        note: [size, pcs?`${pcs} pcs`:'' , note].filter(Boolean).join(' • ')
      };

      try{
        const res = await placeSteadfastOrder(uid, pass, order);
        if (res?.consignment){
          out.innerHTML = `<span class="ok">Success:</span> ${res.message || 'Created'} • Tracking: <strong>${res.consignment.tracking_code}</strong>`;
        } else {
          out.textContent = res?.message || 'Created';
        }
      }catch(e){
        out.innerHTML = `<span class="bad">Error:</span> ${e.message || String(e)}`;
      }
    });

    // init
    refreshState();
  </script>
</body>
</html>
