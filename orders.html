<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pack & Wrap • Orders</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    /* Page polish */
    .wrap{ display:grid; gap:12px; }
    .grid{ display:grid; gap:12px; grid-template-columns: 1.2fr .8fr; }
    @media(max-width:920px){ .grid{ grid-template-columns:1fr; } }
    .card{ padding:14px; border-radius:16px; }
    .h{ margin:0 0 8px; font-size:16px; letter-spacing:.2px; color:#e7dff1; }
    .row{ display:grid; gap:8px; grid-template-columns:1fr 1fr; }
    .row > *{ min-width:0; }
    @media(max-width:640px){ .row{ grid-template-columns:1fr; } }
    textarea{ min-height:140px; resize:vertical; }
    .muted{ color:var(--muted); font-size:12px; }
    .badge{ font-size:12px; padding:4px 8px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.06); }
    .ok{ color:#22c55e; }
    .err{ color:#ef4444; }
    .inline{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
  </style>
</head>

<body class="bg-grad" id="page-orders">
  <div class="bg-figurines" aria-hidden="true">
    <span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span>
  </div>

  <!-- NAVBAR (as requested) -->
  <header class="topbar">
    <div class="brand-row">
      <span class="brand">Pack &amp; Wrap</span>
      <span class="chip" id="overallProfitChip">Overall 0 TK</span>
    </div>
    <div class="tabs-wrap">
      <button id="navToggle" class="nav-toggle" type="button">☰ Menu</button>
      <nav class="tabs" id="mainTabs">
        <a href="/overview.html"    data-route="overview"    id="tabOverview">Overview</a>
        <a href="/products.html"    data-route="products"    id="tabProducts">Products</a>
        <a href="/investments.html" data-route="investments" id="tabInvestments">Investments</a>
        <a href="/sales.html"       data-route="sales"       id="tabSales">Sales</a>
        <a href="/customers.html"   data-route="customers"   id="tabCustomers">Customers</a>
        <a href="/boost.html"       data-route="boost"       id="tabBoost">Boost</a>
        <a href="/orders.html"      data-route="orders"      id="tabParcels" aria-current="page">Orders</a>
        <a href="/backup.html"      data-route="backup"      id="tabBackup">Backup</a>
        <a class="btn ghost" href="#" id="logoutBtn">Logout</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="section wrap">
      <!-- Connect / Status -->
      <div class="card" id="connectCard">
        <h3 class="h">Connect to Steadfast</h3>
        <p class="muted">Create API keys in your Steadfast dashboard: after login open <em>More ▸ API</em>, create a new key, then paste <strong>Api-Key</strong> and <strong>Secret-Key</strong> below. We encrypt & store them per-user.</p>
        <div class="row" style="margin-top:8px;">
          <div>
            <label>Api-Key</label>
            <input id="sfApiKey" type="text" autocomplete="off"/>
          </div>
          <div>
            <label>Secret-Key</label>
            <input id="sfSecretKey" type="password" autocomplete="new-password"/>
          </div>
          <div>
            <label>Protect with a password (to encrypt your keys)</label>
            <input id="sfPassphrase" type="password" autocomplete="new-password"/>
          </div>
          <div>
            <label>Company (optional)</label>
            <input id="sfCompany" type="text" autocomplete="organization"/>
          </div>
          <div>
            <label>Owner name (optional)</label>
            <input id="sfOwner" type="text" autocomplete="name"/>
          </div>
          <div>
            <label>Merchant ID (optional)</label>
            <input id="sfMerchant" type="text" autocomplete="off"/>
          </div>
        </div>
        <div class="actions" style="margin-top:10px;">
          <button class="btn primary" id="btnSaveVerify">Save &amp; Verify</button>
          <span id="connectStatus" class="muted"></span>
        </div>
      </div>

      <!-- Connected summary -->
      <div class="card" id="statusCard" style="display:none;">
        <div class="inline">
          <h3 class="h" style="margin:0;">Steadfast</h3>
          <span class="badge ok" id="statusBadge">Connected</span>
          <span id="balance" class="muted">—</span>
        </div>
        <div id="merchantInfo" class="muted" style="margin-top:6px;"></div>
        <div class="actions" style="margin-top:10px;">
          <button class="btn" id="btnUnlock">Unlock keys to place orders</button>
          <button class="btn ghost" id="btnDisconnect">Disconnect</button>
        </div>
      </div>

      <!-- Order composer -->
      <div class="grid">
        <div class="card">
          <h3 class="h">Paste Confirmation Message</h3>
          <textarea id="orderPaste" spellcheck="false"></textarea>
          <div class="muted" style="margin-top:6px;">We’ll auto-detect name, phone, address, size &amp; quantity. Edit anything below before placing the order.</div>
        </div>
        <div class="card">
          <h3 class="h">Review &amp; Confirm</h3>
          <div class="row">
            <div>
              <label>Recipient Name</label>
              <input id="fName" type="text"/>
            </div>
            <div>
              <label>Phone</label>
              <input id="fPhone" type="text"/>
            </div>
            <div>
              <label>Address</label>
              <input id="fAddr" type="text"/>
            </div>
            <div>
              <label>Size / Item</label>
              <input id="fSize" type="text"/>
            </div>
            <div>
              <label>Total Lot (pcs)</label>
              <input id="fPieces" type="number" inputmode="numeric" min="0"/>
            </div>
            <div>
              <label>COD Amount (BDT)</label>
              <input id="fCod" type="number" inputmode="decimal" min="0" step="0.01"/>
            </div>
          </div>
          <div class="row" style="margin-top:8px;">
            <div>
              <label>Invoice (unique)</label>
              <input id="fInvoice" type="text"/>
            </div>
            <div>
              <label>Note (optional)</label>
              <input id="fNote" type="text" value="Order via Pack & Wrap"/>
            </div>
          </div>
          <div class="actions" style="margin-top:10px;">
            <button class="btn primary" id="btnPlace" disabled>Place Order</button>
            <span id="placeStatus" class="muted"></span>
          </div>
        </div>
      </div>

      <!-- Result -->
      <div class="card" id="resultCard" style="display:none;">
        <h3 class="h">Order Result</h3>
        <pre id="resultBox" style="white-space:pre-wrap;word-break:break-word;"></pre>
      </div>
    </section>
  </main>

  <script type="module">
    import {
      parseOrderMessage, saveSteadfastKeys, verifySteadfastKeys, hasSteadfastKeys,
      getSteadfastProfile, placeSteadfastOrder, bnToEnDigits
    } from './app.js';

    // ---------- Auth & pretty URL ----------
    (function(){
      const authed = (sessionStorage.getItem('pw_authed') === '1') || (localStorage.getItem('pw_authed') === '1');
      const uid = sessionStorage.getItem('pw_userId') || localStorage.getItem('pw_userId');
      if(!authed || !uid){ history.replaceState({}, '', '/login'); location.replace('index.html'); return; }
      const want = `/${encodeURIComponent(uid)}/orders`;
      if (location.pathname !== want) history.replaceState({}, '', want);

      // Wire navbar for pretty URLs
      const nav = document.getElementById('mainTabs');
      if (nav) {
        nav.querySelectorAll('a[data-route]').forEach(a=>{
          const route = a.getAttribute('data-route');
          a.setAttribute('href', `/${route}.html`);
          a.addEventListener('click', function(e){
            if (a.id === 'logoutBtn') return;
            e.preventDefault();
            history.replaceState({}, '', `/${encodeURIComponent(uid)}/${route}`);
            location.assign(`/${route}.html`);
          });
        });
      }

      document.getElementById('navToggle')?.addEventListener('click', ()=>{
        document.getElementById('mainTabs')?.classList.toggle('show');
      });

      // Logout
      document.getElementById('logoutBtn')?.addEventListener('click', (e)=>{
        e.preventDefault();
        sessionStorage.removeItem('pw_authed');
        sessionStorage.removeItem('pw_userId');
        localStorage.removeItem('pw_authed');
        localStorage.removeItem('pw_userId');
        history.replaceState({}, '', '/login');
        location.replace('index.html');
      });
    })();

    const uid = sessionStorage.getItem('pw_userId') || localStorage.getItem('pw_userId');

    // ---------- UI refs ----------
    const els = {
      connectCard: document.getElementById('connectCard'),
      statusCard:  document.getElementById('statusCard'),
      statusBadge: document.getElementById('statusBadge'),
      balance:     document.getElementById('balance'),
      info:        document.getElementById('merchantInfo'),
      btnSaveVerify: document.getElementById('btnSaveVerify'),
      btnUnlock:   document.getElementById('btnUnlock'),
      btnDisconnect: document.getElementById('btnDisconnect'),
      connectStatus: document.getElementById('connectStatus'),

      api: document.getElementById('sfApiKey'),
      sec: document.getElementById('sfSecretKey'),
      pass:document.getElementById('sfPassphrase'),
      company: document.getElementById('sfCompany'),
      owner:   document.getElementById('sfOwner'),
      mid:     document.getElementById('sfMerchant'),

      orderPaste: document.getElementById('orderPaste'),
      fName:   document.getElementById('fName'),
      fPhone:  document.getElementById('fPhone'),
      fAddr:   document.getElementById('fAddr'),
      fSize:   document.getElementById('fSize'),
      fPieces: document.getElementById('fPieces'),
      fCod:    document.getElementById('fCod'),
      fInvoice:document.getElementById('fInvoice'),
      fNote:   document.getElementById('fNote'),
      btnPlace:document.getElementById('btnPlace'),
      placeStatus: document.getElementById('placeStatus'),
      resultCard: document.getElementById('resultCard'),
      resultBox:  document.getElementById('resultBox')
    };

    function setConnectedUI(connected, balanceText, profile){
      els.connectCard.style.display = connected ? 'none' : '';
      els.statusCard.style.display  = connected ? '' : 'none';
      if (connected){
        els.statusBadge.textContent = 'Connected';
        els.statusBadge.classList.remove('err'); els.statusBadge.classList.add('ok');
        els.balance.textContent = balanceText ? `Balance: ${balanceText} BDT` : '';
        const parts = [];
        if (profile?.companyName) parts.push(profile.companyName);
        if (profile?.ownerName) parts.push(`Owner: ${profile.ownerName}`);
        if (profile?.merchantId) parts.push(`Merchant ID: ${profile.merchantId}`);
        els.info.textContent = parts.join(' • ');
      }
    }

    // On load, if keys exist we still need a passphrase to unlock; show “Connect” until verified.
    (async function initConnect(){
      try{
        const exists = await hasSteadfastKeys(uid);
        if (!exists) return; // show connect form
        // show minimal “unlock” card
        const profile = await getSteadfastProfile(uid);
        setConnectedUI(true, '', profile);
        els.balance.textContent = 'Balance: — (unlock to fetch)';
      }catch(e){ /* ignore */ }
    })();

    // Save & Verify
    els.btnSaveVerify.addEventListener('click', async ()=>{
      els.connectStatus.textContent = '';
      const api  = (els.api.value||'').trim();
      const sec  = (els.sec.value||'').trim();
      const pass = (els.pass.value||'').trim();
      const company = (els.company.value||'').trim();
      const owner   = (els.owner.value||'').trim();
      const mid     = (els.mid.value||'').trim();

      if (!api || !sec || !pass){ els.connectStatus.textContent = 'Enter Api-Key, Secret-Key and a password.'; return; }

      els.btnSaveVerify.disabled = true;
      els.connectStatus.textContent = 'Saving & verifying…';
      try{
        await saveSteadfastKeys(uid, pass, { apiKey: api, secretKey: sec }, { companyName: company, ownerName: owner, merchantId: mid });
        const v = await verifySteadfastKeys(uid, pass);
        const bal = (v && (v.current_balance ?? v.balance)) ?? '';
        setConnectedUI(true, String(bal), { companyName: company, ownerName: owner, merchantId: mid });
        els.connectStatus.textContent = '';
      }catch(err){
        els.connectStatus.textContent = 'Failed to verify. Check keys & network.';
        console.error(err);
      }finally{
        els.btnSaveVerify.disabled = false;
      }
    });

    // Unlock (just verify using stored keys + passphrase)
    els.btnUnlock.addEventListener('click', async ()=>{
      const pass = prompt('Enter your password (to decrypt your keys):') || '';
      if (!pass) return;
      els.statusBadge.textContent = 'Verifying…';
      els.statusBadge.classList.remove('ok'); els.statusBadge.classList.add('err');
      try{
        const v = await verifySteadfastKeys(uid, pass);
        const bal = (v && (v.current_balance ?? v.balance)) ?? '';
        els.statusBadge.textContent = 'Connected'; els.statusBadge.classList.remove('err'); els.statusBadge.classList.add('ok');
        els.balance.textContent = bal ? `Balance: ${bal} BDT` : '';
        // Remember pass in memory for this tab to enable placing orders
        sessionStorage.setItem('pw_sf_pass', pass);
        els.btnPlace.disabled = false;
      }catch(err){
        els.statusBadge.textContent = 'Not connected';
        console.error(err);
        alert('Failed to verify. Check keys & network.');
      }
    });

    // Disconnect
    els.btnDisconnect.addEventListener('click', ()=>{
      // Simple: forget unlock for this tab
      sessionStorage.removeItem('pw_sf_pass');
      els.btnPlace.disabled = true;
      alert('Keys remain saved in your account. This only removed the unlock from this tab.');
    });

    // ---------- Parsing UX ----------
    function genInvoice(){
      const d = new Date();
      const pad = n=>String(n).padStart(2,'0');
      return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
    }

    function populateFromText(txt){
      const o = parseOrderMessage(txt||'');
      els.fName.value   = o.name || '';
      els.fPhone.value  = o.phone || '';
      els.fAddr.value   = o.address || '';
      els.fSize.value   = o.size || '';
      els.fPieces.value = o.pieces || '';
      els.fCod.value    = o.codAmount || '';
      if (!els.fInvoice.value) els.fInvoice.value = genInvoice();
    }

    els.orderPaste.addEventListener('input', ()=> populateFromText(els.orderPaste.value));

    // ---------- Place Order ----------
    els.btnPlace.addEventListener('click', async ()=>{
      els.placeStatus.textContent = '';
      const pass = sessionStorage.getItem('pw_sf_pass') || prompt('Enter your password (to decrypt your keys):') || '';
      if (!pass) return;

      const order = {
        invoice: (els.fInvoice.value||'').trim() || genInvoice(),
        recipient_name: (els.fName.value||'').trim(),
        recipient_phone: bnToEnDigits((els.fPhone.value||'').trim()),
        recipient_address: (els.fAddr.value||'').trim(),
        cod_amount: Number((els.fCod.value||'0').trim()),
        item_description: (els.fSize.value||'').trim(),
        total_lot: Number((els.fPieces.value||'0').trim()) || 0,
        delivery_type: 0,
        note: (els.fNote.value||'').trim()
      };

      // Minimal validation
      if (!order.recipient_name || !order.recipient_phone || !order.recipient_address){
        els.placeStatus.textContent = 'Name, phone, and address are required.';
        return;
      }

      els.btnPlace.disabled = true;
      els.placeStatus.textContent = 'Placing order…';
      try{
        const resp = await placeSteadfastOrder(uid, pass, order);
        els.resultCard.style.display = '';
        els.resultBox.textContent = JSON.stringify(resp, null, 2);
        els.placeStatus.textContent = 'Done.';
      }catch(err){
        console.error(err);
        els.placeStatus.textContent = 'Failed to place order.';
        alert('Failed to place order: ' + (err?.message || err));
      }finally{
        els.btnPlace.disabled = false;
      }
    });
  </script>
</body>
</html>
