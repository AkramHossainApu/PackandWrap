<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pack & Wrap • Orders</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .page-wrap{ max-width:1000px; margin:0 auto; padding:16px; }
    .grid{ display:grid; gap:12px; }
    .card{ border-radius:16px; padding:14px; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .two{ display:grid; gap:10px; grid-template-columns:1fr 1fr; }
    .three{ display:grid; gap:10px; grid-template-columns:repeat(3,1fr); }
    .field{ display:grid; gap:6px; }
    .field input, .field textarea, .field select { width:100%; }
    .muted{ color:var(--muted); font-size:12px; }
    .ok{ color:#86efac; }
    .err{ color:#fecaca; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; }
    .chip{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.06); }
    .hl{ font-weight:700; }
    @media (max-width:760px){
      .two{ grid-template-columns:1fr; }
      .three{ grid-template-columns:1fr; }
    }

    /* ===== Topbar (identical to Overview) ===== */
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(17,24,39,.85), rgba(17,24,39,.65));
      border-bottom:1px solid var(--border);
    }
    .brand-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 16px; }
    .brand{
      font-weight:900; letter-spacing:.3px; font-size:18px;
      background:linear-gradient(90deg,#fff,#d8b4fe,#f9a8d4);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow:0 2px 8px rgba(0,0,0,.25);
    }
    .tabs-wrap{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:0 8px 10px 8px; }
    .nav-toggle{
      display:none; border:1px solid var(--border); background:rgba(255,255,255,.06);
      padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:6px; border:1px solid var(--border); border-radius:12px;
      background:rgba(255,255,255,.04);
    }
    .tabs a{ text-decoration:none; padding:8px 12px; border-radius:10px; color:inherit; transition:background .15s ease, color .15s ease, transform .15s ease; }
    .tabs a:hover{ background:rgba(255,255,255,.08); transform:translateY(-1px); }
    .tabs a[aria-current="page"]{ background:linear-gradient(90deg,#a78bfa22,#f472b622); border:1px solid var(--border); font-weight:700; }
    .tabs .btn.ghost{ margin-left:4px; }
    @media (max-width:760px){
      .nav-toggle{ display:inline-block; }
      .tabs{ display:none; width:100%; flex-direction:column; }
      .tabs.show{ display:flex; }
      .tabs a, .tabs .btn.ghost{ width:100%; text-align:left; margin-left:0; }
    }
  </style>
</head>
<body class="bg-grad" id="page-orders">
  <div class="bg-figurines" aria-hidden="true">
    <span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span>
  </div>

  <!-- Navbar (exactly like Overview) -->
  <header class="topbar">
    <div class="brand-row">
      <span class="brand">Pack &amp; Wrap</span>
      <span class="chip" id="overallProfitChip">Orders</span>
    </div>
    <div class="tabs-wrap">
      <button id="navToggle" class="nav-toggle" type="button">☰ Menu</button>
      <nav class="tabs" id="mainTabs">
        <a href="/overview.html"    data-route="overview"    id="tabOverview">Overview</a>
        <a href="/products.html"    data-route="products"    id="tabProducts">Products</a>
        <a href="/investments.html" data-route="investments" id="tabInvestments">Investments</a>
        <a href="/sales.html"       data-route="sales"       id="tabSales">Sales</a>
        <a href="/customers.html"   data-route="customers"   id="tabCustomers">Customers</a>
        <a href="/boost.html"       data-route="boost"       id="tabBoost">Boost</a>
        <a href="/orders.html"      data-route="orders"      id="tabParcels" aria-current="page">Orders</a>
        <a href="/backup.html"      data-route="backup"      id="tabBackup">Backup</a>
        <a class="btn ghost" href="#" id="logoutBtn">Logout</a>
      </nav>
    </div>
  </header>

  <main class="page-wrap">
    <!-- CONNECT / VERIFY -->
    <section id="connectPanel" class="card grid" style="display:none;">
      <h3 style="margin:0;">Connect Steadfast</h3>
      <div class="muted">
        Get your <span class="hl">API Key</span> and <span class="hl">Secret Key</span> from your Steadfast portal (More → API → Create key).  
        We’ll verify and save them encrypted (you’ll set a passphrase to unlock later).
      </div>
      <div class="two">
        <div class="field"><label>API Key</label><input id="apiKey" autocomplete="off"></div>
        <div class="field"><label>Secret Key</label><input id="secretKey" autocomplete="off"></div>
      </div>
      <div class="field"><label>Create a passphrase (for encryption)</label><input id="passphraseCreate" type="password" autocomplete="new-password"></div>
      <div class="actions">
        <button class="btn primary" id="btnVerifySave">Verify &amp; Save</button>
        <span id="connectMsg" class="muted"></span>
      </div>
    </section>

    <!-- UNLOCK -->
    <section id="unlockPanel" class="card grid" style="display:none;">
      <h3 style="margin:0;">Unlock Keys</h3>
      <div class="two">
        <div class="field"><label>Passphrase</label><input id="passphraseUnlock" type="password" autocomplete="current-password"></div>
      </div>
      <div class="actions">
        <button class="btn" id="btnUnlock">Unlock</button>
        <button class="btn ghost" id="btnDisconnect">Disconnect</button>
        <span id="unlockMsg" class="muted"></span>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profilePanel" class="card grid" style="display:none;">
      <div class="row" style="justify-content:space-between;">
        <div class="grid" style="gap:4px;">
          <div id="profileTitle" style="font-weight:800;">Steadfast Merchant</div>
          <div id="profileSub" class="muted"></div>
        </div>
        <div id="balanceChip" class="chip">Balance: —</div>
      </div>
    </section>

    <!-- ORDER PASTE + REVIEW -->
    <section id="orderPanel" class="card grid" style="display:none;">
      <h3 style="margin:0;">Paste Confirmation Message</h3>
      <textarea id="orderPaste" rows="8"></textarea>

      <div class="three">
        <div class="field"><label>Customer Name</label><input id="fName"></div>
        <div class="field"><label>Phone</label><input id="fPhone"></div>
        <div class="field"><label>Pieces</label><input id="fPieces" type="number" min="1"></div>
      </div>
      <div class="two">
        <div class="field"><label>Address</label><input id="fAddress"></div>
        <div class="field"><label>Size / Notes (goes to note)</label><input id="fSize"></div>
      </div>
      <div class="two">
        <div class="field"><label>COD Amount (৳)</label><input id="fCod" type="number" min="0" step="1"></div>
        <div class="field"><label>Invoice (optional)</label><input id="fInvoice" placeholder=""></div>
      </div>

      <div class="actions">
        <button class="btn" id="btnParse">Parse</button>
        <button class="btn primary" id="btnPlace">Place via Steadfast</button>
        <span id="orderMsg" class="muted"></span>
      </div>
    </section>
  </main>

  <script type="module">
    import {
      hasSteadfastKeys, saveSteadfastKeys, unlockSteadfastKeys, getSteadfastProfile,
      verifySteadfastKeys, placeSteadfastOrder, parseOrderMessage
    } from './app.js';

    // ---------- Auth & pretty URLs ----------
    (function(){
      const authed = (sessionStorage.getItem('pw_authed') === '1') || (localStorage.getItem('pw_authed') === '1');
      const uid = sessionStorage.getItem('pw_userId') || localStorage.getItem('pw_userId');
      if(!authed || !uid){
        history.replaceState({}, '', '/login');
        location.replace('index.html');
        return;
      }
      const want = `/${encodeURIComponent(uid)}/orders`;
      if (location.pathname !== want) history.replaceState({}, '', want);

      // Wire nav to keep pretty URLs
      const nav = document.getElementById('mainTabs');
      if (nav) {
        nav.querySelectorAll('a[data-route]').forEach(a=>{
          const route = a.getAttribute('data-route');
          a.setAttribute('href', `/${route}.html`);
          a.addEventListener('click', (e)=>{ e.preventDefault(); history.replaceState({}, '', `/${encodeURIComponent(uid)}/${route}`); location.assign(`/${route}.html`); });
        });
      }

      // Mobile nav
      document.getElementById('navToggle')?.addEventListener('click', ()=>{
        document.getElementById('mainTabs')?.classList.toggle('show');
      });
      // Logout
      document.getElementById('logoutBtn')?.addEventListener('click', (e)=>{
        e.preventDefault();
        sessionStorage.removeItem('pw_authed');
        sessionStorage.removeItem('pw_userId');
        localStorage.removeItem('pw_authed');
        localStorage.removeItem('pw_userId');
        history.replaceState({}, '', '/login');
        location.replace('index.html');
      });

      // Init UI with key state
      init(uid);
    })();

    async function init(userId){
      const has = await hasSteadfastKeys(userId);
      show('connectPanel', !has);
      show('unlockPanel',  has);
      show('profilePanel', false);
      show('orderPanel',   false);

      // If profile exists, render
      const prof = await getSteadfastProfile(userId);
      if (prof && (prof.companyName || prof.ownerName || prof.merchantId || prof.balance != null)){
        renderProfile(prof);
        show('profilePanel', true);
      }
    }

    function show(id, vis){ const el = document.getElementById(id); if (!el) return; el.style.display = vis ? '' : 'none'; }

    // ---------- Connect / Verify / Save ----------
    document.getElementById('btnVerifySave')?.addEventListener('click', async ()=>{
      const apiKey = document.getElementById('apiKey').value.trim();
      const secretKey = document.getElementById('secretKey').value.trim();
      const pass = document.getElementById('passphraseCreate').value;
      const msg = document.getElementById('connectMsg'); msg.textContent = '';

      if(!apiKey || !secretKey || !pass){ msg.textContent = 'Enter API Key, Secret Key and a passphrase.'; return; }
      msg.textContent = 'Verifying…';
      try{
        const v = await verifySteadfastKeys(apiKey, secretKey);
        if(!v.ok){ msg.textContent = 'Failed to verify. Check keys & network.'; return; }

        // Save keys encrypted + profile (balance is what we have for sure)
        const uid = sessionStorage.getItem('pw_userId') || localStorage.getItem('pw_userId');
        await saveSteadfastKeys(uid, pass, { apiKey, secretKey }, { balance: v.profile?.balance ?? null });

        msg.textContent = 'Connected ✓';
        renderProfile({ balance: v.profile?.balance ?? null });
        show('connectPanel', false);
        show('unlockPanel', true);
        show('profilePanel', true);
      }catch(e){
        console.error(e);
        msg.textContent = 'Failed to verify. Check keys & network.';
      }
    });

    // ---------- Unlock ----------
    document.getElementById('btnUnlock')?.addEventListener('click', async ()=>{
      const pass = document.getElementById('passphraseUnlock').value;
      const msg = document.getElementById('unlockMsg'); msg.textContent='';
      const uid = sessionStorage.getItem('pw_userId') || localStorage.getItem('pw_userId');
      if (!pass){ msg.textContent='Enter passphrase.'; return; }
      try{
        await unlockSteadfastKeys(uid, pass); // If wrong → throws
        msg.textContent = 'Unlocked ✓';
        show('orderPanel', true);
        // keep pass in memory for this tab
        window.__steadfastPass = pass;
      }catch(e){
        console.error(e);
        msg.textContent = 'Wrong passphrase.';
      }
    });

    // Disconnect (remove saved keys/profile)
    document.getElementById('btnDisconnect')?.addEventListener('click', async ()=>{
      const uid = sessionStorage.getItem('pw_userId') || localStorage.getItem('pw_userId');
      await fetch('/__/store/clear', { method:'POST' }).catch(()=>{});
      // quick clear via app.js store API (open rules)
      await import('./app.js').then(async ({store})=>{
        await store.setUserKV(uid, 'steadfast.keys', null);
        await store.setUserKV(uid, 'steadfast.profile', null);
      });
      location.reload();
    });

    function renderProfile(prof){
      const title = document.getElementById('profileTitle');
      const sub   = document.getElementById('profileSub');
      const bal   = document.getElementById('balanceChip');
      const owner = prof.ownerName ? `Owner: ${prof.ownerName}` : '';
      const comp  = prof.companyName || 'Steadfast Merchant';
      const mid   = prof.merchantId ? ` • ID: ${prof.merchantId}` : '';
      title.textContent = comp;
      sub.textContent   = [owner, mid].filter(Boolean).join(' ');
      if (prof.balance != null) bal.textContent = `Balance: ${prof.balance}`;
    }

    // ---------- Paste → Parse ----------
    document.getElementById('btnParse')?.addEventListener('click', parseNow);
    document.getElementById('orderPaste')?.addEventListener('input', (e)=>{
      if ((e.target.value||'').trim().length > 8) parseNow();
    });

    function fill(o){
      document.getElementById('fName').value    = o.name||'';
      document.getElementById('fPhone').value   = o.phone||'';
      document.getElementById('fAddress').value = o.address||'';
      document.getElementById('fSize').value    = o.size||'';
      document.getElementById('fPieces').value  = o.pieces||'';
      document.getElementById('fCod').value     = o.codAmount||'';
    }

    function parseNow(){
      const raw = document.getElementById('orderPaste').value||'';
      const o = parseOrderMessage(raw);
      fill(o);
    }

    // ---------- Place Order ----------
    document.getElementById('btnPlace')?.addEventListener('click', async ()=>{
      const msg = document.getElementById('orderMsg'); msg.textContent='';
      const uid = sessionStorage.getItem('pw_userId') || localStorage.getItem('pw_userId');
      const pass = window.__steadfastPass;
      if (!pass){ msg.textContent = 'Unlock first.'; return; }

      const order = buildOrderPayload();
      if (!order.recipient_name || !order.recipient_number || !order.recipient_address){
        msg.textContent = 'Name, phone, address are required.'; return;
      }
      msg.textContent = 'Placing order…';
      try{
        const result = await placeSteadfastOrder(uid, pass, order);
        msg.textContent = 'Order placed ✓';
        console.log('Steadfast result:', result);
      }catch(e){
        console.error(e);
        msg.textContent = 'Failed to place order.';
      }
    });

    function buildOrderPayload(){
      // Minimal common payload used across community docs:
      // recipient_name, recipient_number, recipient_address, cod_amount, invoice, note, quantity, weight(optional)
      const name    = document.getElementById('fName').value.trim();
      const phone   = document.getElementById('fPhone').value.trim();
      const address = document.getElementById('fAddress').value.trim();
      const note    = document.getElementById('fSize').value.trim();
      const pieces  = parseInt(document.getElementById('fPieces').value||'0',10) || 1;
      const codAmt  = Number(document.getElementById('fCod').value||0) || 0;
      const invoice = document.getElementById('fInvoice').value.trim() || `INV-${Date.now()}`;
      return {
        recipient_name: name,
        recipient_number: phone,
        recipient_address: address,
        cod_amount: codAmt,
        invoice,
        note,
        quantity: pieces,
        weight: 1 // default
      };
    }
  </script>
</body>
</html>
