<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pack & Wrap • Orders</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    /* Compact, responsive layout for Orders */
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .hgroup { display:grid; gap:6px; margin:14px 0; }
    .hgroup h2 { margin:0; font-size:22px; }
    .hgroup .sub { margin:0; color:var(--muted); font-size:13px; }

    .grid { display:grid; gap:12px; grid-template-columns:1fr 1fr; }
    @media (max-width:840px){ .grid{ grid-template-columns:1fr; } }

    .card.pad { padding:14px; }
    .row { display:grid; gap:10px; grid-template-columns:1fr 1fr; }
    .row .full { grid-column: 1 / -1; }
    @media (max-width:620px){ .row{ grid-template-columns:1fr; } }

    textarea.input { min-height: 140px; resize: vertical; }

    .ok { color:#34d399; font-weight:600; }
    .bad { color:#f87171; font-weight:600; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:13px; }

    .btn-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .sep{ height:1px; background:var(--border); margin:10px 0; }
    .muted{ color:var(--muted); font-size:12px; }
    .pill{ padding:4px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; background:rgba(255,255,255,.04); }
  </style>
</head>

<body class="bg-grad" id="page-orders">
  <div class="bg-figurines" aria-hidden="true">
    <span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span>
  </div>

  <!-- Navbar (same as overview, with Orders tab) -->
  <header class="topbar">
    <div class="brand-row">
      <span class="brand">Pack &amp; Wrap</span>
      <span class="chip" id="overallProfitChip">Overall 0 TK</span>
    </div>

    <div class="tabs-wrap">
      <button id="navToggle" class="nav-toggle" type="button">☰ Menu</button>
      <nav class="tabs" id="mainTabs">
        <a href="/overview.html"    data-route="overview"    id="tabOverview">Overview</a>
        <a href="/products.html"    data-route="products"    id="tabProducts">Products</a>
        <a href="/investments.html" data-route="investments" id="tabInvestments">Investments</a>
        <a href="/sales.html"       data-route="sales"       id="tabSales">Sales</a>
        <a href="/customers.html"   data-route="customers"   id="tabCustomers">Customers</a>
        <a href="/boost.html"       data-route="boost"       id="tabBoost">Boost</a>
        <a href="/orders.html"      data-route="orders"      id="tabParcels" aria-current="page">Orders</a>
        <a href="/backup.html"      data-route="backup"      id="tabBackup">Backup</a>
        <a class="btn ghost" href="#" id="logoutBtn">Logout</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <div class="wrap">
      <div class="hgroup">
        <h2>Orders</h2>
        <p class="sub">Connect Steadfast once, then paste a confirmation message to auto-fill and place the parcel.</p>
      </div>

      <!-- CONNECT / VERIFY -->
      <section class="card pad" id="connectCard">
        <h3 style="margin-top:0">Connect Steadfast</h3>
        <p class="muted">Log in to the Steadfast merchant panel → <strong>More</strong> → <strong>API</strong> → create a new key, then paste below. We’ll verify via <span class="mono">/get_balance</span> and store them encrypted.</p>
        <div class="row" style="margin-top:10px">
          <label class="full">API Key
            <input id="sfApi" class="input" autocomplete="off"/>
          </label>
          <label class="full">Secret Key
            <input id="sfSecret" class="input" autocomplete="off"/>
          </label>
          <label class="full">Unlock phrase (for local encryption)
            <input id="sfPass" class="input" autocomplete="new-password"/>
          </label>
        </div>
        <div class="btn-row" style="margin-top:8px">
          <button id="btnVerifySave" class="btn primary">Verify &amp; Save</button>
          <span id="connectStatus" class="muted"></span>
        </div>
        <div class="sep"></div>
        <div class="muted">Already saved? Enter your unlock phrase and press <em>Unlock</em>.</div>
        <div class="btn-row" style="margin-top:8px">
          <button id="btnUnlock" class="btn">Unlock</button>
          <button id="btnDisconnect" class="btn ghost">Disconnect</button>
          <span id="unlockStatus" class="muted"></span>
        </div>
      </section>

      <!-- ACCOUNT (after verified/unlocked) -->
      <section class="card pad" id="accountCard" style="display:none">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <div>
            <div style="font-weight:800;">Steadfast Account</div>
            <div class="muted">Verified via <span class="mono">/get_balance</span>. <span id="acctBalance" class="pill">Balance —</span></div>
          </div>
          <div class="btn-row">
            <button id="btnRotate" class="btn">Update Keys</button>
            <button id="btnLock" class="btn ghost">Lock</button>
          </div>
        </div>
      </section>

      <!-- PASTE & PARSE -->
      <section class="card pad" id="orderCard" style="display:none">
        <h3 style="margin-top:0">Paste Confirmation Message</h3>
        <label class="full">
          <textarea id="msg" class="input mono" aria-label="Paste order confirmation message here"></textarea>
        </label>

        <div class="row" style="margin-top:12px">
          <label>Name
            <input id="name" class="input"/>
          </label>
          <label>Phone
            <input id="phone" class="input"/>
          </label>
          <label class="full">Address
            <input id="address" class="input"/>
          </label>
          <label>Size / Description
            <input id="size" class="input"/>
          </label>
          <label>Pieces (Total Lot)
            <input id="pieces" class="input" inputmode="numeric"/>
          </label>
          <label>COD Amount (BDT)
            <input id="cod" class="input" inputmode="decimal"/>
          </label>
        </div>

        <div class="btn-row" style="margin-top:12px">
          <button id="btnParse" class="btn">Parse Again</button>
          <button id="btnPlace" class="btn primary">Place Order</button>
          <span id="placeStatus" class="muted"></span>
        </div>
      </section>

      <!-- RESULT -->
      <section class="card pad" id="resultCard" style="display:none">
        <div id="resultBox" class="mono"></div>
      </section>
    </div>
  </main>

  <script type="module">
    import {
      hasSteadfastKeys, unlockSteadfastKeys, verifySteadfastKeys,
      getSteadfastProfile, saveSteadfastKeys,
      parseOrderMessage, placeSteadfastOrder, makeInvoice
    } from './app.js';

    // ---------- Auth & pretty URL ----------
    (function(){
      const authed = (sessionStorage.getItem('pw_authed') === '1') || (localStorage.getItem('pw_authed') === '1');
      const uid = sessionStorage.getItem('pw_userId') || localStorage.getItem('pw_userId');
      if(!authed || !uid){ history.replaceState({}, '', '/login'); location.replace('index.html'); return; }
      const want = `/${encodeURIComponent(uid)}/orders`;
      if (location.pathname !== want) history.replaceState({}, '', want);

      // Wire navbar links to pretty URLs + actual files
      const nav = document.getElementById('mainTabs');
      if (nav) {
        nav.querySelectorAll('a[data-route]').forEach(a=>{
          const route = a.getAttribute('data-route');
          a.setAttribute('href', `/${route}.html`);
          a.addEventListener('click', function(e){
            if (a.id === 'logoutBtn') return;
            e.preventDefault();
            history.replaceState({}, '', `/${encodeURIComponent(uid)}/${route}`);
            location.assign(`/${route}.html`);
          });
        });
      }

      // Logout
      document.getElementById('logoutBtn')?.addEventListener('click', (e)=>{
        e.preventDefault();
        sessionStorage.removeItem('pw_authed');
        sessionStorage.removeItem('pw_userId');
        localStorage.removeItem('pw_authed');
        localStorage.removeItem('pw_userId');
        history.replaceState({}, '', '/login');
        location.replace('index.html');
      });

      // Mobile toggle
      document.getElementById('navToggle')?.addEventListener('click', ()=>{
        document.getElementById('mainTabs')?.classList.toggle('show');
      });

      window.__uid = uid;
    })();

    const $ = s=>document.querySelector(s);
    const connectCard = $('#connectCard');
    const accountCard = $('#accountCard');
    const orderCard   = $('#orderCard');
    const resultCard  = $('#resultCard');

    const sfApi   = $('#sfApi');
    const sfSecret= $('#sfSecret');
    const sfPass  = $('#sfPass');

    const connectStatus = $('#connectStatus');
    const unlockStatus  = $('#unlockStatus');
    const acctBalance   = $('#acctBalance');

    // Fields
    const msg   = $('#msg');
    const nameF = $('#name');
    const phoneF= $('#phone');
    const addrF = $('#address');
    const sizeF = $('#size');
    const pcsF  = $('#pieces');
    const codF  = $('#cod');

    // Buttons
    $('#btnVerifySave')?.addEventListener('click', async ()=>{
      connectStatus.textContent = '';
      try{
        const bal = await verifySteadfastKeys(window.__uid, sfPass.value || '', sfApi.value || '', sfSecret.value || '');
        connectStatus.innerHTML = '<span class="ok">Connected.</span>';
        acctBalance.textContent = `Balance ${bal?.current_balance ?? '—'}`;
        connectCard.style.display = 'none';
        accountCard.style.display = '';
        orderCard.style.display = '';
      }catch(err){
        connectStatus.innerHTML = '<span class="bad">Failed to verify. Check keys & network.</span>';
        console.error(err);
      }
    });

    $('#btnUnlock')?.addEventListener('click', async ()=>{
      unlockStatus.textContent = '';
      try{
        await unlockSteadfastKeys(window.__uid, sfPass.value || '');
        unlockStatus.innerHTML = '<span class="ok">Unlocked.</span>';
        // Optionally fetch balance by verifying again silently is tricky without keys exposed here.
        connectCard.style.display = 'none';
        accountCard.style.display = '';
        orderCard.style.display = '';
      }catch(err){
        unlockStatus.innerHTML = '<span class="bad">Unlock failed (wrong phrase or no keys saved).</span>';
      }
    });

    $('#btnDisconnect')?.addEventListener('click', async ()=>{
      // Clear saved keys by overwriting with empty (or you can add a delete route)
      try{
        await saveSteadfastKeys(window.__uid, (sfPass.value||'temp'), { apiKey:'', secretKey:'' });
      }catch(_){}
      connectCard.style.display = '';
      accountCard.style.display = 'none';
      orderCard.style.display = 'none';
    });

    $('#btnRotate')?.addEventListener('click', ()=>{
      connectCard.style.display = '';
      accountCard.style.display = 'none';
      orderCard.style.display = 'none';
    });

    $('#btnLock')?.addEventListener('click', ()=>{
      connectCard.style.display = '';
      accountCard.style.display = 'none';
      orderCard.style.display = 'none';
    });

    // Initialize view (has keys?)
    (async function init(){
      try{
        const has = await hasSteadfastKeys(window.__uid);
        if (has){
          // Show unlock
          connectCard.style.display = '';
          accountCard.style.display = 'none';
          orderCard.style.display = 'none';
        } else {
          // Ask to connect
          connectCard.style.display = '';
          accountCard.style.display = 'none';
          orderCard.style.display = 'none';
        }
      }catch(_){}
    })();

    // Parsing
    function doParse(){
      const o = window.lastParsed = (msg.value ? (awaitOrSync(()=>parseOrderMessage(msg.value))) : null);
      if (o){
        if (!nameF.value)  nameF.value  = o.name || '';
        if (!phoneF.value) phoneF.value = o.phone || '';
        if (!addrF.value)  addrF.value  = o.address || '';
        if (!sizeF.value)  sizeF.value  = o.size || '';
        if (!pcsF.value)   pcsF.value   = o.pieces || '';
        if (!codF.value)   codF.value   = o.codAmount || '';
      }
    }
    function awaitOrSync(fn){ try{ return fn(); }catch{ return null; } }

    $('#btnParse')?.addEventListener('click', doParse);
    msg?.addEventListener('input', ()=>{
      // lightweight auto parse on pause
      clearTimeout(window.__pT);
      window.__pT = setTimeout(doParse, 250);
    });

    // Place Order
    $('#btnPlace')?.addEventListener('click', async ()=>{
      $('#placeStatus').textContent = '';
      try{
        const invoice = makeInvoice(window.__uid);
        const order = {
          invoice,
          recipient_name:  nameF.value.trim(),
          recipient_phone: phoneF.value.trim(),
          recipient_address: addrF.value.trim(),
          cod_amount: Number(codF.value || 0),
          item_description: sizeF.value.trim() || undefined,
          total_lot: pcsF.value ? Number(pcsF.value) : undefined,
          delivery_type: 0, // 0=home delivery
          note: 'Pack & Wrap'
        };
        if (!order.recipient_name || !order.recipient_phone || !order.recipient_address || !order.cod_amount){
          $('#placeStatus').innerHTML = '<span class="bad">Name, phone, address, COD are required.</span>';
          return;
        }
        const out = await placeSteadfastOrder(window.__uid, sfPass.value || '', order);
        $('#resultBox').textContent = JSON.stringify(out, null, 2);
        resultCard.style.display = '';
        $('#placeStatus').innerHTML = '<span class="ok">Order placed.</span>';
      }catch(err){
        console.error(err);
        $('#placeStatus').innerHTML = '<span class="bad">Failed to place order.</span>';
      }
    });

  </script>
</body>
</html>
