<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pack & Wrap • Orders</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    /* Topbar (same as Overview) */
    .topbar{ position:sticky; top:0; z-index:50; backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(17,24,39,.85), rgba(17,24,39,.65));
      border-bottom:1px solid var(--border); }
    .brand-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 16px; }
    .brand{ font-weight:900; letter-spacing:.3px; font-size:18px;
      background:linear-gradient(90deg,#fff,#d8b4fe,#f9a8d4);
      -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:0 2px 8px rgba(0,0,0,.25);}
    .chip{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.06); }
    .tabs-wrap{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:0 8px 10px 8px; }
    .nav-toggle{ display:none; border:1px solid var(--border); background:rgba(255,255,255,.06); padding:8px 12px; border-radius:10px; cursor:pointer; }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; padding:6px; border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,.04); }
    .tabs a{ text-decoration:none; padding:8px 12px; border-radius:10px; color:inherit; transition:background .15s ease, color .15s ease, transform .15s ease; }
    .tabs a:hover{ background:rgba(255,255,255,.08); transform:translateY(-1px); }
    .tabs a[aria-current="page"]{ background:linear-gradient(90deg,#a78bfa22,#f472b622); border:1px solid var(--border); font-weight:700; }
    .tabs .btn.ghost{ margin-left:4px; }
    @media (max-width:760px){
      .nav-toggle{ display:inline-block; }
      .tabs{ display:none; width:100%; flex-direction:column; }
      .tabs.show{ display:flex; }
      .tabs a, .tabs .btn.ghost{ width:100%; text-align:left; }
      .tabs .btn.ghost{ margin-left:0; }
    }

    /* Page layout */
    .page{ display:grid; gap:16px; margin:16px auto; max-width:1000px; padding:0 12px; }
    .section-title{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .who{ display:flex; gap:10px; align-items:center; color:#e7dff1; }
    .who .name{ font-weight:800; }
    .who .meta{ color:var(--muted); font-size:12px; }

    .card.soft{ padding:16px; border-radius:16px; }
    .inline{ display:flex; gap:10px; flex-wrap:wrap; }
    .inline > * { flex:1; min-width:220px; }
    .help{ color:var(--muted); font-size:12px; }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    @media (max-width:860px){ .grid2{ grid-template-columns:1fr; } }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; }
    .ok{ color:#22c55e; }
    .err{ color:#f87171; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }

    textarea{ width:100%; min-height:160px; resize:vertical; }
    .tableish{ display:grid; gap:10px; }
    .row{ display:grid; grid-template-columns:120px 1fr; gap:8px; align-items:center; }
    .row label{ color:var(--muted); font-size:12px; }
    .row input,.row textarea{ width:100%; }
  </style>
</head>

<body class="bg-grad" id="page-orders">
  <div class="bg-figurines" aria-hidden="true">
    <span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span>
  </div>

  <!-- Navbar -->
  <header class="topbar">
    <div class="brand-row">
      <span class="brand">Pack &amp; Wrap</span>
      <span class="chip" id="overallProfitChip">Overall 0 TK</span>
    </div>

    <div class="tabs-wrap">
      <button id="navToggle" class="nav-toggle" type="button">☰ Menu</button>
      <nav class="tabs" id="mainTabs">
        <a href="/overview.html"    data-route="overview"    id="tabOverview">Overview</a>
        <a href="/products.html"    data-route="products"    id="tabProducts">Products</a>
        <a href="/investments.html" data-route="investments" id="tabInvestments">Investments</a>
        <a href="/sales.html"       data-route="sales"       id="tabSales">Sales</a>
        <a href="/customers.html"   data-route="customers"   id="tabCustomers">Customers</a>
        <a href="/boost.html"       data-route="boost"       id="tabBoost">Boost</a>
        <a href="/orders.html"      data-route="orders"      id="tabParcels" aria-current="page">Orders</a>
        <a href="/backup.html"      data-route="backup"      id="tabBackup">Backup</a>
        <a class="btn ghost" href="#" id="logoutBtn">Logout</a>
      </nav>
    </div>
  </header>

  <main class="page">
    <div class="section-title">
      <div class="who">
        <div class="name" id="merchantName">Orders</div>
        <div class="meta" id="merchantMeta"></div>
      </div>
      <div id="connectState" class="help"></div>
    </div>

    <!-- CONNECT CARD (shows only when not connected or not unlocked) -->
    <section class="card soft" id="connectCard" style="display:none">
      <h3 style="margin:0 0 8px">Connect to Steadfast</h3>
      <p class="help" style="margin:0 0 10px">
        Get your API Key & Secret Key: after logging into Steadfast, open the main menu → “More” → “API” → create a new API key.
      </p>

      <div class="inline" id="connectInputs">
        <div>
          <label>API Key</label>
          <input id="sfApiKey" autocomplete="off"/>
        </div>
        <div>
          <label>Secret Key</label>
          <input id="sfSecretKey" autocomplete="off"/>
        </div>
        <div>
          <label>Local Passphrase (to lock/unlock your keys)</label>
          <input id="sfPass" type="password" autocomplete="new-password"/>
        </div>
      </div>

      <div class="inline" style="margin-top:8px">
        <div>
          <label>Company Name (optional)</label>
          <input id="sfCompany" autocomplete="organization"/>
        </div>
        <div>
          <label>Owner Name (optional)</label>
          <input id="sfOwner" autocomplete="name"/>
        </div>
        <div>
          <label>Merchant/User ID (optional)</label>
          <input id="sfMerchantId" autocomplete="off"/>
        </div>
      </div>

      <div class="actions" style="margin-top:12px">
        <button class="btn primary" id="btnVerifySave">Verify &amp; Save</button>
        <button class="btn" id="btnUnlockSaved">I already saved keys → Unlock</button>
        <span id="connectMsg" class="help"></span>
      </div>
    </section>

    <!-- UNLOCK CARD (shown if keys exist but locked) -->
    <section class="card soft" id="unlockCard" style="display:none">
      <h3 style="margin:0 0 8px">Unlock your saved keys</h3>
      <div class="inline">
        <div>
          <label>Local Passphrase</label>
          <input id="unlockPass" type="password" autocomplete="current-password"/>
        </div>
      </div>
      <div class="actions" style="margin-top:12px">
        <button class="btn primary" id="btnUnlockGo">Unlock</button>
        <button class="btn ghost" id="btnRelock" style="display:none">Lock</button>
        <span id="unlockMsg" class="help"></span>
      </div>
    </section>

    <!-- ORDER CARD (visible when connected & unlocked) -->
    <section class="card soft" id="orderCard" style="display:none">
      <div class="grid2">
        <div>
          <h3 style="margin:0 0 8px">Paste confirmation message</h3>
          <!-- no placeholder per your request -->
          <textarea id="pasteBox"></textarea>
          <div class="actions" style="margin-top:8px">
            <button class="btn" id="btnParse">Parse</button>
          </div>
        </div>

        <div>
          <h3 style="margin:0 0 8px">Review &amp; edit</h3>
          <div class="tableish">
            <div class="row"><label>Name</label><input id="fName"/></div>
            <div class="row"><label>Phone</label><input id="fPhone"/></div>
            <div class="row"><label>Address</label><textarea id="fAddr" rows="3"></textarea></div>
            <div class="row"><label>Size/Note</label><input id="fSize"/></div>
            <div class="row"><label>Pieces</label><input id="fPieces" type="number" min="0"/></div>
            <div class="row"><label>COD (BDT)</label><input id="fCod" type="number" min="0" step="0.01"/></div>
          </div>

          <div class="actions" style="margin-top:10px">
            <button class="btn primary" id="btnPlace">Place Order</button>
            <span id="placeMsg" class="help"></span>
          </div>

          <div id="resultBox" class="mono" style="margin-top:10px; font-size:13px;"></div>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import {
      parseOrderMessage,
      hasSteadfastKeys, saveSteadfastKeys, unlockSteadfastKeys, getSteadfastProfile,
      verifySteadfastKeysRaw, verifySteadfastKeys, placeSteadfastOrder
    } from './app.js';

    // ---------- Auth gate & pretty URL ----------
    (function(){
      const authed = (sessionStorage.getItem('pw_authed') === '1') || (localStorage.getItem('pw_authed') === '1');
      const uid = sessionStorage.getItem('pw_userId') || localStorage.getItem('pw_userId');

      if(!authed || !uid){
        history.replaceState({}, '', '/login');
        location.replace('index.html');
        return;
      }

      const want = `/${encodeURIComponent(uid)}/orders`;
      if (location.pathname !== want) {
        history.replaceState({}, '', want);
      }

      // Wire navbar links to pretty URLs
      const nav = document.getElementById('mainTabs');
      if (nav) {
        nav.querySelectorAll('a[data-route]').forEach(a=>{
          const route = a.getAttribute('data-route');
          a.setAttribute('href', `/${route}.html`);
          a.addEventListener('click', function(e){
            if (a.id === 'logoutBtn') return;
            e.preventDefault();
            history.replaceState({}, '', `/${encodeURIComponent(uid)}/${route}`);
            location.assign(`/${route}.html`);
          });
        });
      }

      // Mobile nav toggle
      document.getElementById('navToggle')?.addEventListener('click', ()=>{
        document.getElementById('mainTabs')?.classList.toggle('show');
      });

      // Logout
      document.getElementById('logoutBtn')?.addEventListener('click', (e)=>{
        e.preventDefault();
        sessionStorage.removeItem('pw_authed');
        sessionStorage.removeItem('pw_userId');
        localStorage.removeItem('pw_authed');
        localStorage.removeItem('pw_userId');
        history.replaceState({}, '', '/login');
        location.replace('index.html');
      });
    })();

    // ---------- Page logic ----------
    const uid = sessionStorage.getItem('pw_userId') || localStorage.getItem('pw_userId');

    const merchantName = document.getElementById('merchantName');
    const merchantMeta = document.getElementById('merchantMeta');
    const connectState = document.getElementById('connectState');

    const connectCard = document.getElementById('connectCard');
    const unlockCard  = document.getElementById('unlockCard');
    const orderCard   = document.getElementById('orderCard');

    const sfApiKey    = document.getElementById('sfApiKey');
    const sfSecretKey = document.getElementById('sfSecretKey');
    const sfPass      = document.getElementById('sfPass');
    const sfCompany   = document.getElementById('sfCompany');
    const sfOwner     = document.getElementById('sfOwner');
    const sfMerchantId= document.getElementById('sfMerchantId');
    const connectMsg  = document.getElementById('connectMsg');

    const btnVerifySave = document.getElementById('btnVerifySave');
    const btnUnlockSaved= document.getElementById('btnUnlockSaved');

    const unlockPass   = document.getElementById('unlockPass');
    const btnUnlockGo  = document.getElementById('btnUnlockGo');
    const btnRelock    = document.getElementById('btnRelock');
    const unlockMsg    = document.getElementById('unlockMsg');

    const pasteBox = document.getElementById('pasteBox');
    const btnParse = document.getElementById('btnParse');
    const fName = document.getElementById('fName');
    const fPhone= document.getElementById('fPhone');
    const fAddr = document.getElementById('fAddr');
    const fSize = document.getElementById('fSize');
    const fPieces=document.getElementById('fPieces');
    const fCod  = document.getElementById('fCod');
    const btnPlace = document.getElementById('btnPlace');
    const placeMsg = document.getElementById('placeMsg');
    const resultBox= document.getElementById('resultBox');

    function setHeader(profile){
      const company = profile?.companyName || 'Orders';
      const owner   = profile?.ownerName ? ` • ${profile.ownerName}` : '';
      merchantName.textContent = company;
      merchantMeta.textContent = `${profile?.merchantId ? ('ID: '+profile.merchantId+' • ') : ''}${uid}${owner}`;
    }

    async function refreshState(){
      setHeader(await getSteadfastProfile(uid));
      const exists = await hasSteadfastKeys(uid);
      connectState.textContent = exists ? 'Connected (locked)' : 'Not connected';
      connectCard.style.display = exists ? 'none' : 'block';
      unlockCard.style.display  = exists ? 'block' : 'none';
      orderCard.style.display   = 'none';
      btnRelock.style.display   = 'none';
      resultBox.textContent = '';
      placeMsg.textContent = '';
    }

    await refreshState();

    // Verify & Save
    btnVerifySave?.addEventListener('click', async ()=>{
      connectMsg.textContent = '';
      try{
        const apiKey = sfApiKey.value.trim();
        const secretKey = sfSecretKey.value.trim();
        const pass = sfPass.value;
        if(!apiKey || !secretKey || !pass){ connectMsg.textContent='Please enter API Key, Secret Key and a passphrase.'; return; }

        // verify against server
        connectMsg.textContent = 'Verifying…';
        const v = await verifySteadfastKeysRaw(apiKey, secretKey);

        // save encrypted + profile (user-provided basic info)
        await saveSteadfastKeys(uid, pass, { apiKey, secretKey }, {
          companyName: sfCompany.value,
          ownerName:   sfOwner.value,
          merchantId:  sfMerchantId.value
        });
        connectMsg.textContent = `Connected ✓ (Balance: ${v?.balance ?? '—'})`;
        await refreshState();
      }catch(err){
        console.error(err);
        connectMsg.textContent = 'Verification failed. Check keys and try again.';
      }
    });

    // Unlock flow
    btnUnlockSaved?.addEventListener('click', ()=>{
      // reveal the unlock card directly (if keys exist)
      connectCard.style.display = 'none';
      unlockCard.style.display  = 'block';
    });

    btnUnlockGo?.addEventListener('click', async ()=>{
      unlockMsg.textContent = '';
      try{
        const pass = unlockPass.value;
        if(!pass){ unlockMsg.textContent='Enter your local passphrase.'; return; }
        // test by calling verify with saved keys
        unlockMsg.textContent = 'Checking…';
        await verifySteadfastKeys(uid, pass);
        unlockMsg.textContent = 'Unlocked ✓';
        connectState.textContent = 'Connected (unlocked)';
        orderCard.style.display = 'block';
        btnRelock.style.display = 'inline-flex';
      }catch(err){
        console.error(err);
        unlockMsg.textContent = 'Unlock failed. Wrong passphrase?';
      }
    });

    btnRelock?.addEventListener('click', async ()=>{
      orderCard.style.display = 'none';
      unlockCard.style.display= 'block';
      connectState.textContent = 'Connected (locked)';
      unlockMsg.textContent = 'Locked.';
      unlockPass.value = '';
      resultBox.textContent = '';
      placeMsg.textContent = '';
    });

    // Parse
    function doParse(){
      const o = parseOrderMessage(pasteBox.value || '');
      fName.value  = o.name || '';
      fPhone.value = o.phone || '';
      fAddr.value  = o.address || '';
      fSize.value  = o.size || '';
      fPieces.value= o.pieces || '';
      fCod.value   = o.codAmount || '';
    }
    btnParse?.addEventListener('click', doParse);

    // Place order
    btnPlace?.addEventListener('click', async ()=>{
      placeMsg.textContent = '';
      resultBox.textContent = '';
      const pass = unlockPass.value;
      if(!pass){ placeMsg.textContent='Unlock first (enter passphrase).'; return; }

      // required fields
      const name  = fName.value.trim();
      const phone = fPhone.value.trim();
      const addr  = fAddr.value.trim();
      const cod   = Number((fCod.value||'').trim());
      if(!name || !phone || !addr || !(cod >= 0)){ placeMsg.textContent='Fill Name, Phone, Address, COD.'; return; }

      // map to API fields
      const invoice = `${uid}-${Date.now().toString(36).toUpperCase()}`;
      const order = {
        invoice,
        recipient_name: name,
        recipient_phone: phone,
        recipient_address: addr,
        cod_amount: cod,
        note: fSize.value.trim() || undefined,
        item_description: fSize.value.trim() || undefined,
        total_lot: fPieces.value ? Number(fPieces.value) : undefined,
        delivery_type: 0
      };

      placeMsg.textContent = 'Placing…';
      try{
        const ans = await placeSteadfastOrder(uid, pass, order);
        // expected success payload shape per docs
        const c = ans?.consignment || {};
        placeMsg.textContent = 'Order placed ✓';
        resultBox.textContent =
          `Consignment ID: ${c.consignment_id ?? '—'}\n` +
          `Tracking Code : ${c.tracking_code ?? '—'}\n` +
          `Status        : ${c.status ?? ans?.status ?? '—'}`;
      }catch(err){
        console.error(err);
        placeMsg.textContent = 'Failed to place order.';
        resultBox.textContent = String(err?.message || err);
      }
    });

    // convenience: parse on first paste
    pasteBox?.addEventListener('paste', ()=>{
      setTimeout(doParse, 0);
    });
  </script>
</body>
</html>
