<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pack & Wrap ‚Ä¢ Login</title>
  <link rel="stylesheet" href="styles.css"/>

  <!-- Pretty URL + 404 fallback handling + root redirect -->
  <script>
    (function () {
      var params = new URLSearchParams(location.search);
      var p = params.get('p');

      // 404 fallback can land here with ?p=/some/pretty/path
      if (p && /^\/[^/]+\/overview$/.test(decodeURIComponent(p))) {
        var pretty = decodeURIComponent(p);
        history.replaceState({}, '', pretty);
        location.replace('/overview.html'); // load the actual file
        return;
      }

      // Decide what to do on root or /login
      var path = location.pathname;
      if (path === '/' || path.endsWith('/index.html') || path.endsWith('/login.html') || (p && decodeURIComponent(p) === '/login')) {
        // If "remembered" (localStorage) OR active tab session, go to overview
        var uid = localStorage.getItem('pw_userId') || sessionStorage.getItem('pw_userId');
        var authed = (localStorage.getItem('pw_authed') === '1') || (sessionStorage.getItem('pw_authed') === '1');

        if (authed && uid) {
          history.replaceState({}, '', `/${encodeURIComponent(uid)}/overview`);
          location.replace('/overview.html');
          return;
        }

        // Otherwise, keep pretty /login
        history.replaceState({}, '', '/login');
      }
    })();
  </script>

  <style>
    /* keep the login card centered */
    body { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:16px; position:relative; }

    /* your existing look for the card/form */
    .auth-wrap{ width:100%; max-width:460px; padding:20px; }
    .auth-header{ text-align:center; margin-bottom:8px; }
    .auth-sub{ color:var(--muted); font-size:14px; margin:0 0 14px; text-align:center; }
    .field{ display:grid; gap:6px; margin-bottom:12px; }
    .field .row{ display:flex; gap:8px; align-items:center; }
    .field .row input{ flex:1; }
    .actions{ display:grid; gap:10px; margin-top:12px; }
    .err-banner{ display:none; margin:12px 0 0; padding:10px 12px; border-radius:12px; border:1px solid #ef4444; background:rgba(239,68,68,.1); color:#fecaca; font-size:14px; }
    .err-banner.show{ display:block; }
    .divider{ display:flex; align-items:center; gap:10px; color:var(--muted); font-size:12px; margin:8px 0; }
    .divider::before,.divider::after{ content:""; height:1px; flex:1; background:var(--border); }
    .loading{ opacity:.7; pointer-events:none; }
    .brand{ font-size:26px; font-weight:900; letter-spacing:.5px; text-align:center; background:linear-gradient(90deg,#fff,#d8b4fe,#f9a8d4); -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:0 2px 8px rgba(0,0,0,.25); }
    .btn.alt{ border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.06); box-shadow:0 6px 18px rgba(196,181,253,.18); }

    /* remove underline for link styled as button */
    a.btn, a.btn:visited { text-decoration: none; }

    /* Avatar wrapper ‚Äî keeps figure inside the circle and matches page background */
    .avatar-wrap{ display:flex; justify-content:center; margin-bottom:10px; }
    .svgContainer{
      position:relative; width:200px; height:200px;
      border-radius:50%;
      overflow:hidden;              /* keep figure inside circle */
      pointer-events:none;          /* avatar never blocks clicks */
      background: transparent;      /* show page background through the hole */
    }
    .svgContainer > div{ position:relative; width:100%; height:100%; }
    .svgContainer .mySVG{
      position:absolute; left:0; top:0; width:100%; height:100%;
      pointer-events:none;
    }
    /* Make the big background circle transparent to match page */
    .mySVG > circle:first-of-type { fill: transparent !important; }

    /* keep eye button clickable above everything */
    #togglePw { position:relative; z-index:5; }
  </style>
</head>

<body>
  <div class="bg-figurines" aria-hidden="true">
    <span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span>
  </div>

  <main class="card auth-wrap" style="z-index:1">
    <div class="auth-header">
      <h1 class="brand">Pack &amp; Wrap</h1>
      <p class="auth-sub">Welcome back ‚Äî manage your Sales ‚Ä¢ Inventory ‚Ä¢ Profit</p>
    </div>

    <!-- Avatar -->
    <div class="avatar-wrap">
      <div class="svgContainer">
        <div>
          <!-- ===== Avatar SVG (verbatim) ===== -->
          <!-- (SVG content unchanged) -->
          <!-- Keep your full SVG exactly as you sent; omitted here for brevity -->
          <!-- ===== end SVG ===== -->
        </div>
      </div>
    </div>

    <!-- Login form -->
    <form id="loginForm" class="form vgap" autocomplete="off" novalidate>
      <div class="field">
        <label for="u">User ID</label>
        <input id="u" name="userid" type="text" required autocomplete="username" placeholder="yourid123"/>
        <div class="helper">Use the User ID you chose at signup.</div>
      </div>

      <div class="field">
        <label for="p">Password</label>
        <div class="row">
          <input id="p" name="password" type="password" required autocomplete="current-password" placeholder="Your password"/>
          <button class="btn alt" id="togglePw" type="button" aria-label="Show password">üëÅ</button>
        </div>
      </div>

      <div class="field" style="display:flex; align-items:center; gap:8px;">
        <input type="checkbox" id="remember"/>
        <label for="remember">Remember me</label>
      </div>

      <div class="actions">
        <button class="btn primary" id="loginBtn" type="submit">Login</button>
        <div class="divider"><span>or</span></div>
        <div style="text-align:center; font-size:13px; color:var(--muted);">Don‚Äôt have an account?</div>
        <a class="btn alt" href="/signup">Signup</a>
      </div>

      <p id="loginErr" class="err-banner" role="alert" aria-live="assertive"></p>
    </form>
  </main>

  <!-- GSAP for avatar -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.3/TweenMax.min.js"></script>

  <!-- Eye button toggle -->
  <script>
    (function(){
      var pw = document.getElementById('p');
      var toggle = document.getElementById('togglePw');
      if (toggle && pw) {
        toggle.addEventListener('click', function(ev){
          ev.preventDefault();
          var isPw = pw.type === 'password';
          pw.type = isPw ? 'text' : 'password';
          toggle.textContent = isPw ? 'üôà' : 'üëÅ';
          toggle.setAttribute('aria-label', isPw ? 'Hide password' : 'Show password');
          // keep user in password section; hands stay on eyes
          pw.focus();
          if (window.avatar) {
            if (isPw) window.avatar.spreadFingers();
            else window.avatar.closeFingers();
          }
        });
      }
    })();
  </script>

  <!-- Login logic ‚Äî robust dynamic import + NO optimistic fallback -->
  <script type="module">
    const form = document.getElementById('loginForm');
    const err  = document.getElementById('loginErr');
    const btn  = document.getElementById('loginBtn');
    const pw   = document.getElementById('p');
    const user = document.getElementById('u');
    const remember = document.getElementById('remember');

    user && user.focus();

    function showError(msg){ err.textContent = msg; err.classList.add('show'); }
    function clearError(){ err.textContent = ''; err.classList.remove('show'); }

    // Try to import app.js and get login function
    let loginUserById = null;
    try {
      const mod = await import('./app.js');
      loginUserById = mod.loginUserById || (mod.default && mod.default.loginUserById) || null;
    } catch (e) {
      // swallow here; we show a message on submit
      console.error('Failed to import app.js', e);
    }

    // If already logged in (session or remembered), go straight to overview
    (function(){
      const uid = localStorage.getItem('pw_userId') || sessionStorage.getItem('pw_userId');
      const authed = (localStorage.getItem('pw_authed') === '1') || (sessionStorage.getItem('pw_authed') === '1');
      if (authed && uid) {
        history.replaceState({}, '', `/${encodeURIComponent(uid)}/overview`);
        location.replace('/overview.html'); // absolute
      }
    })();

    form.addEventListener('submit', async e=>{
      e.preventDefault();
      clearError();

      const userId = (user.value || '').trim();
      const pval   = pw.value || '';
      if(!userId || !pval){
        showError('Please enter both User ID and password.');
        return;
      }

      if (typeof loginUserById !== 'function') {
        showError('Login temporarily unavailable (app failed to load). Please refresh the page.');
        return;
      }

      form.classList.add('loading'); btn.textContent = 'Logging in‚Ä¶';
      try{
        const res = await loginUserById(userId, pval);
        if(res && res.ok){
          // always set session for this tab
          sessionStorage.setItem('pw_authed','1');
          sessionStorage.setItem('pw_userId', res.userId);

          // persist across tabs only if "Remember me" is checked
          if(remember.checked){
            localStorage.setItem('pw_authed','1');
            localStorage.setItem('pw_userId', res.userId);
          } else {
            localStorage.removeItem('pw_authed');
            localStorage.removeItem('pw_userId');
          }

          history.replaceState({}, '', `/${encodeURIComponent(res.userId)}/overview`);
          location.replace('/overview.html');
        } else {
          showError('Invalid User ID or password. Please try again.');
        }
      }catch(errEx){
        console.error(errEx);
        showError('Unable to reach the server. Check your connection and try again.');
      } finally {
        form.classList.remove('loading'); btn.textContent = 'Login';
      }
    });
  </script>

  <!-- Avatar JS (unchanged; hands cover eyes; fingers toggle only) -->
  <script>
    (function(){
      if (typeof TweenMax === 'undefined') return;

      var userInput  = document.querySelector('#u'),
          password   = document.querySelector('#p'),
          toggleBtn  = document.querySelector('#togglePw'),
          mySVGBox   = document.querySelector('.svgContainer'),
          mySVG      = document.querySelector('.mySVG'),
          twoFingers = document.querySelector('.twoFingers'),
          armL       = document.querySelector('.armL'),
          armR       = document.querySelector('.armR'),
          eyeL       = document.querySelector('.eyeL'),
          eyeR       = document.querySelector('.eyeR'),
          nose       = document.querySelector('.nose'),
          mouth      = document.querySelector('.mouth'),
          mouthBG    = document.querySelector('.mouthBG'),
          mouthSmall = document.querySelector('.mouthSmallBG'),
          mouthMed   = document.querySelector('.mouthMediumBG'),
          mouthLg    = document.querySelector('.mouthLargeBG'),
          mouthMaskPath = document.querySelector('#mouthMaskPath'),
          mouthOutline  = document.querySelector('.mouthOutline'),
          tooth      = document.querySelector('.tooth'),
          tongue     = document.querySelector('.tongue'),
          chin       = document.querySelector('.chin'),
          face       = document.querySelector('.face'),
          eyebrow    = document.querySelector('.eyebrow'),
          outerEarL  = document.querySelector('.earL .outerEar'),
          outerEarR  = document.querySelector('.earR .outerEar'),
          earHairL   = document.querySelector('.earL .earHair'),
          earHairR   = document.querySelector('.earR .earHair'),
          hair       = document.querySelector('.hair');

      if (!mySVGBox || !userInput) return;

      var screenCenter, svgCoords, inputCoords, inputScrollMax,
          chinMin = .5, dFromC, eyeScale = 1, eyesCovered = false;

      var eyeLCoords, eyeRCoords, noseCoords, mouthCoords, eyeLAngle, eyeLX, eyeLY, eyeRAngle, eyeRX, eyeRY,
          noseAngle, noseX, noseY, mouthAngle, mouthX, mouthY, mouthR, chinX, chinY, chinS, faceX, faceY,
          faceSkew, eyebrowSkew, outerEarX, outerEarY, hairX, hairS;

      function getAngle(x1, y1, x2, y2) { return Math.atan2(y1 - y2, x1 - x2); }
      function getPosition(el){
        var xPos=0,yPos=0;
        while (el){
          if (el.tagName=="BODY"){
            var xScroll = el.scrollLeft || document.documentElement.scrollLeft;
            var yScroll = el.scrollTop  || document.documentElement.scrollTop;
            xPos += (el.offsetLeft - xScroll + el.clientLeft);
            yPos += (el.offsetTop  - yScroll + el.clientTop);
          } else {
            xPos += (el.offsetLeft - el.scrollLeft + el.clientLeft);
            yPos += (el.offsetTop  - el.scrollTop  + el.clientTop);
          }
          el = el.offsetParent;
        }
        return {x:xPos,y:yPos};
      }

      // Swap the mouth paths directly (no MorphSVG)
      function setMouthFromPath(pathEl) {
        if (!pathEl) return;
        var d = pathEl.getAttribute('d');
        if (d) {
          mouthBG.setAttribute('d', d);
          mouthMaskPath.setAttribute('d', d);
          mouthOutline.setAttribute('d', d);
        }
      }
      function mouthSmallState(){
        setMouthFromPath(mouthSmall);
        TweenMax.to(tooth, 0.25, {x:0, y:0, ease: Expo.easeOut});
        TweenMax.to(tongue,0.25, {y:0, ease: Expo.easeOut});
        TweenMax.to([eyeL, eyeR], 0.25, {scaleX:1, scaleY:1, ease: Expo.easeOut}); eyeScale = 1;
      }
      function mouthMediumState(){
        setMouthFromPath(mouthMed);
        TweenMax.to(tooth, 0.25, {x:0, y:0, ease: Expo.easeOut});
        TweenMax.to(tongue,0.25, {x:0, y:1, ease: Expo.easeOut});
        TweenMax.to([eyeL, eyeR], 0.25, {scaleX:.85, scaleY:.85, ease: Expo.easeOut}); eyeScale = .85;
      }
      function mouthLargeState(){
        setMouthFromPath(mouthLg);
        TweenMax.to(tooth, 0.25, {x:3, y:-2, ease: Expo.easeOut});
        TweenMax.to(tongue,0.25, {y:2, ease: Expo.easeOut});
        TweenMax.to([eyeL, eyeR], 0.25, {scaleX:.65, scaleY:.65, ease: Expo.easeOut}); eyeScale = .65;
      }

      function calculateFaceMove(){
        var carPos = userInput.selectionEnd;
        if (carPos == null) carPos = userInput.value.length;

        var div = document.createElement('div'), span = document.createElement('span'),
            copyStyle = getComputedStyle(userInput);
        [].forEach.call(copyStyle, function(prop){ div.style[prop] = copyStyle[prop]; });
        div.style.position = 'absolute';
        div.style.visibility='hidden';
        div.style.whiteSpace='pre';
        document.body.appendChild(div);
        div.textContent = userInput.value.substr(0, carPos);
        span.textContent = userInput.value.substr(carPos) || '.';
        div.appendChild(span);

        var caretAbs = getPosition(span);
        var caretX = caretAbs.x, caretY = caretAbs.y;

        var screenCenter = (getPosition(mySVGBox).x) + (mySVGBox.offsetWidth / 2);
        var eyeLCoords = {x: getPosition(mySVGBox).x + 84,  y: getPosition(mySVGBox).y + 76};
        var eyeRCoords = {x: getPosition(mySVGBox).x + 113, y: getPosition(mySVGBox).y + 76};
        var noseCoords = {x: getPosition(mySVGBox).x + 97,  y: getPosition(mySVGBox).y + 81};
        var mouthCoords= {x: getPosition(mySVGBox).x + 100, y: getPosition(mySVGBox).y + 100};

        var dFromC = screenCenter - caretX;
        var eyeLAngle = Math.atan2(eyeLCoords.y - (caretY + 25), eyeLCoords.x - caretX);
        var eyeRAngle = Math.atan2(eyeRCoords.y - (caretY + 25), eyeRCoords.x - caretX);
        var noseAngle = Math.atan2(noseCoords.y - (caretY + 25), noseCoords.x - caretX);
        var mouthAngle= Math.atan2(mouthCoords.y - (caretY + 25), mouthCoords.x - caretX);

        var eyeLX = Math.cos(eyeLAngle) * 20; var eyeLY = Math.sin(eyeLAngle) * 10;
        var eyeRX = Math.cos(eyeRAngle) * 20; var eyeRY = Math.sin(eyeRAngle) * 10;
        var noseX = Math.cos(noseAngle) * 23; var noseY = Math.sin(noseAngle) * 10;
        var mouthX= Math.cos(mouthAngle)* 23; var mouthY= Math.sin(mouthAngle)* 10;
        var mouthR= Math.cos(mouthAngle)* 6;
        var chinX = mouthX * .8; var chinY = mouthY * .5;
        var chinS = 1 - ((dFromC * .15) / 100);
        if(chinS > 1){ chinS = 1 - (chinS - 1); if(chinS < .5) chinS = .5; }
        var faceX = mouthX * .3; var faceY = mouthY * .4;
        var faceSkew = Math.cos(mouthAngle) * 5;
        var eyebrowSkew = Math.cos(mouthAngle) * 25;
        var outerEarX = Math.cos(mouthAngle) * 4;
        var outerEarY = Math.cos(mouthAngle) * 5;
        var hairX = Math.cos(mouthAngle) * 6;
        var hairS = 1.2;

        TweenMax.to(document.querySelector('.eyeL'), 0.8, {x:-eyeLX, y:-eyeLY, ease: Expo.easeOut});
        TweenMax.to(document.querySelector('.eyeR'), 0.8, {x:-eyeRX, y:-eyeRY, ease: Expo.easeOut});
        TweenMax.to(document.querySelector('.nose'), 0.8, {x:-noseX, y:-noseY, rotation: mouthR, transformOrigin: "center center", ease: Expo.easeOut});
        TweenMax.to(document.querySelector('.mouth'),0.8, {x:-mouthX, y:-mouthY, rotation: mouthR, transformOrigin: "center center", ease: Expo.easeOut});
        TweenMax.to(document.querySelector('.chin'), 0.8, {x:-chinX, y:-chinY, scaleY: chinS, ease: Expo.easeOut});
        TweenMax.to(document.querySelector('.face'), 0.8, {x:-faceX, y:-faceY, skewX:-faceSkew, transformOrigin: "center top", ease: Expo.easeOut});
        TweenMax.to(document.querySelector('.eyebrow'),0.8,{x:-faceX, y:-faceY, skewX:-eyebrowSkew, transformOrigin: "center top", ease: Expo.easeOut});
        TweenMax.to(document.querySelector('.earL .outerEar'),0.8,{x: outerEarX, y:-outerEarY, ease: Expo.easeOut});
        TweenMax.to(document.querySelector('.earR .outerEar'),0.8,{x: outerEarX, y: outerEarY, ease: Expo.easeOut});
        TweenMax.to(document.querySelector('.earL .earHair'),0.8,{x:-outerEarX, y:-outerEarY, ease: Expo.easeOut});
        TweenMax.to(document.querySelector('.earR .earHair'),0.8,{x:-outerEarX, y: outerEarY, ease: Expo.easeOut});
        TweenMax.to(document.querySelector('.hair'),0.8,{x:hairX, scaleY: hairS, transformOrigin:"center bottom", ease: Expo.easeOut});

        document.body.removeChild(div);
      }

      function onUserInput(){
        calculateFaceMove();
        var len = userInput.value.length;
        if (len === 0) {
          mouthSmallState();
        } else if (len < 6) {
          mouthMediumState();
        } else {
          mouthLargeState();
        }
      }

      function coverEyes(){
        if (eyesCovered) return;
        TweenMax.killTweensOf([armL, armR]);
        TweenMax.set([armL, armR], {visibility:"visible"});
        TweenMax.to(armL,.45,{x:-93,y:10,rotation:0,ease:Quad.easeOut});
        TweenMax.to(armR,.45,{x:-93,y:10,rotation:0,ease:Quad.easeOut,delay:.1});
        eyesCovered = true;
      }
      function uncoverEyes(){
        if (!eyesCovered) return;
        TweenMax.killTweensOf([armL, armR]);
        TweenMax.to(armL,1.0,{y:220,ease:Quad.easeOut});
        TweenMax.to(armL,1.0,{rotation:105,ease:Quad.easeOut,delay:.1});
        TweenMax.to(armR,1.0,{y:220,ease:Quad.easeOut});
        TweenMax.to(armR,1.0,{rotation:-105,ease:Quad.easeOut,delay:.1, onComplete:function(){
          TweenMax.set([armL, armR], {visibility:"hidden"});
        }});
        eyesCovered = false;
      }
      function spreadFingers(){ TweenMax.to(twoFingers,.3,{transformOrigin:"bottom left", rotation:30, x:-9,y:-2, ease:Power2.easeInOut}); }
      function closeFingers(){ TweenMax.to(twoFingers,.3,{transformOrigin:"bottom left", rotation:0,  x:0, y:0,  ease:Power2.easeInOut}); }

      function resetFace(){
        TweenMax.to([eyeL, eyeR],0.8,{x:0,y:0,scaleX:1,scaleY:1,ease:Expo.easeOut});
        TweenMax.to(nose,0.8,{x:0,y:0,scaleX:1,scaleY:1,ease:Expo.easeOut});
        TweenMax.to(mouth,0.8,{x:0,y:0,rotation:0,ease:Expo.easeOut});
        TweenMax.to(chin,0.8,{x:0,y:0,scaleY:1,ease:Expo.easeOut});
        TweenMax.to([face,eyebrow],0.8,{x:0,y:0,skewX:0,ease:Expo.easeOut});
        TweenMax.to([outerEarL,outerEarR,earHairL,earHairR,hair],0.8,{x:0,y:0,scaleY:1,ease:Expo.easeOut});
      }

      function startBlinking(delay){
        delay = delay ? Math.floor(Math.random()*delay) : 1;
        TweenMax.to([eyeL, eyeR], .1, {delay:delay, scaleY:0, yoyo:true, repeat:1, transformOrigin:"center center",
          onComplete: function(){ startBlinking(12); }});
      }

      (function init(){
        var svgCoords   = getPosition(mySVGBox);
        var inputCoords = getPosition(userInput);
        var screenCenter = svgCoords.x + (mySVGBox.offsetWidth / 2);
        var eyeLCoords = {x: svgCoords.x + 84,  y: svgCoords.y + 76};
        var eyeRCoords = {x: svgCoords.x + 113, y: svgCoords.y + 76};
        var noseCoords = {x: svgCoords.x + 97,  y: svgCoords.y + 81};
        var mouthCoords= {x: svgCoords.x + 100, y: svgCoords.y + 100};

        userInput.addEventListener('focus', ()=>{ onUserInput(); });
        userInput.addEventListener('blur',  ()=>{ setTimeout(resetFace,120); });
        userInput.addEventListener('input', onUserInput);

        password.addEventListener('focus', ()=>{
          coverEyes();
          if (password.type === 'text') spreadFingers(); else closeFingers();
        });
        password.addEventListener('blur',  ()=>{
          setTimeout(()=>{
            const a = document.activeElement;
            if (a !== toggleBtn && a !== password) { uncoverEyes(); }
          },100);
        });
        toggleBtn.addEventListener('focus', ()=>{
          coverEyes();
          if (password.type === 'text') spreadFingers(); else closeFingers();
        });
        toggleBtn.addEventListener('blur',  ()=>{
          setTimeout(()=>{
            const a = document.activeElement;
            if (a !== password && a !== toggleBtn) { uncoverEyes(); }
          },100);
        });

        TweenMax.set(armL,{x:-93,y:220,rotation:105,transformOrigin:"top left"});
        TweenMax.set(armR,{x:-93,y:220,rotation:-105,transformOrigin:"top right"});
        TweenMax.set(mouth,{transformOrigin:"center center"});

        mouthSmallState();
        startBlinking(5);

        window.avatar = { spreadFingers, closeFingers };
      })();
    })();
  </script>
</body>
</html>
