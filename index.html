<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pack & Wrap ‚Ä¢ Login</title>
  <link rel="stylesheet" href="styles.css"/>

  <!-- Pretty URL + 404 fallback handling + root redirect -->
  <script>
    (function () {
      const params = new URLSearchParams(location.search);
      const p = params.get('p');

      if (p && /^\/[^/]+\/overview$/.test(decodeURIComponent(p))) {
        const pretty = decodeURIComponent(p);
        history.replaceState({}, '', pretty);
        location.replace('/overview.html');
        return;
      }

      const path = location.pathname;
      if (path === '/' || path.endsWith('/index.html') || path.endsWith('/login.html') || (p && decodeURIComponent(p) === '/login')) {
        const uid = localStorage.getItem('pw_userId') || sessionStorage.getItem('pw_userId');
        const authed = (localStorage.getItem('pw_authed') === '1') || (sessionStorage.getItem('pw_authed') === '1');
        if (authed && uid) {
          history.replaceState({}, '', `/${encodeURIComponent(uid)}/overview`);
          location.replace('/overview.html');
          return;
        }
        history.replaceState({}, '', '/login');
      }
    })();
  </script>

  <style>
    :root{
      /* tweak these two to micro-adjust placement */
      --bunny-head-top: -76px;  /* head behind card: less negative = further back */
      --bunny-paws-top: -22px;  /* paws sit half on/half off the top edge */
    }

    /* Page centering */
    body{ min-height:100vh; display:flex; align-items:center; justify-content:center; padding:16px; position:relative; }

    /* Shell so we can layer head behind card and paws above card */
    .auth-shell{ position:relative; width:100%; max-width:520px; }

    /* Login card */
    .auth-wrap{
      position:relative; z-index:3; width:100%;
      padding:20px; padding-top:62px; /* more headroom under paws */
    }
    .auth-header{ text-align:center; margin-bottom:8px; }
    .brand{ font-size:26px; font-weight:900; letter-spacing:.5px; text-align:center; background:linear-gradient(90deg,#fff,#d8b4fe,#f9a8d4); -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:0 2px 8px rgba(0,0,0,.25); }
    .auth-sub{ color:var(--muted); font-size:14px; margin:0 0 14px; text-align:center; }

    .field{ display:grid; gap:6px; margin-bottom:12px; }
    .field .row{ display:flex; gap:8px; align-items:center; }
    .field .row input{ flex:1; }
    .actions{ display:grid; gap:10px; margin-top:12px; }

    .btn.alt{ border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.06); box-shadow:0 6px 18px rgba(196,181,253,.18); }
    a.btn,a.btn:visited{ text-decoration:none; }
    .divider{ display:flex; align-items:center; gap:10px; color:var(--muted); font-size:12px; margin:8px 0; }
    .divider::before,.divider::after{ content:""; height:1px; flex:1; background:var(--border); }
    .err-banner{ display:none; margin:12px 0 0; padding:10px 12px; border-radius:12px; border:1px solid #ef4444; background:rgba(239,68,68,.1); color:#fecaca; font-size:14px; }
    .err-banner.show{ display:block; }
    .loading{ opacity:.7; pointer-events:none; }
    #togglePw{ position:relative; z-index:6; }

    /* ---------------- Bunny layout ---------------- */

    /* Head sits BEHIND the card (ears + a tiny chin peek). */
    .bunny-head{
      position:absolute; left:50%; top:var(--bunny-head-top); transform:translateX(-50%);
      width:220px; height:200px; z-index:1; pointer-events:none;
      transition: transform .25s ease;
    }
    .bunny-head.focused{ transform:translateX(-50%) translateY(-1px); }

    /* Paws sit ON the card edge (in front), half on/half off. */
    .bunny-paws{
      position:absolute; left:50%; top:var(--bunny-paws-top); transform:translateX(-50%);
      width:220px; height:88px; z-index:5; pointer-events:none;
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.25));
    }

    /* Soft, very subtle shadow touching the ledge */
    .ledge-shadow{
      position:absolute; left:24px; right:24px; top:-2px; height:14px; z-index:4; pointer-events:none;
      background: radial-gradient(ellipse at center, rgba(0,0,0,.22), rgba(0,0,0,0) 70%);
      filter: blur(6px); opacity:.35;
    }

    /* Make sure any default circle backdrop in SVG doesn‚Äôt show */
    svg > circle:first-of-type{ fill:transparent!important; }
  </style>
</head>

<body>
  <div class="bg-figurines" aria-hidden="true">
    <span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span>
  </div>

  <div class="auth-shell">
    <!-- Bunny head (behind card, chin barely peeking) -->
    <svg class="bunny-head" viewBox="0 0 220 200" aria-hidden="true">
      <!-- Ears -->
      <g>
        <ellipse cx="70" cy="50" rx="18" ry="52" fill="#fff" stroke="#eaeaea" stroke-width="2"/>
        <ellipse cx="70" cy="50" rx="10" ry="40" fill="#f59ab2"/>
        <ellipse cx="150" cy="50" rx="18" ry="52" fill="#fff" stroke="#eaeaea" stroke-width="2"/>
        <ellipse cx="150" cy="50" rx="10" ry="40" fill="#f59ab2"/>
      </g>

      <!-- Head -->
      <g id="bHead" transform="translate(0,24)">
        <circle cx="110" cy="104" r="50" fill="#fff" stroke="#eaeaea" stroke-width="2"/>

        <!-- Eyes -->
        <g class="eyeL">
          <circle cx="88" cy="100" r="7.2" fill="#2a2a2a"/>
          <circle cx="86.8" cy="98.8" r="1.8" fill="#fff"/>
        </g>
        <g class="eyeR">
          <circle cx="132" cy="100" r="7.2" fill="#2a2a2a"/>
          <circle cx="130.8" cy="98.8" r="1.8" fill="#fff"/>
        </g>

        <!-- Nose -->
        <path class="nose" d="M110 114c4.1 0 6.6-2.8 4.6-4.7l-3.4-3.4c-1.2-1.2-3.1-1.2-4.3 0l-3.5 3.5c-2 1.9 .5 4.6 4.6 4.6z" fill="#ff8ea1"/>

        <!-- Mouth (3 states) -->
        <defs>
          <path id="mSmall" d="M110 121c-7.5 0-14.2-2.3-19.8-6.1a3 3 0 0 1 3.3-5c4.7 3.1 10.4 4.9 16.5 4.9s11.7-1.8 16.5-4.9a3 3 0 0 1 3.3 5c-5.6 3.8-12.3 6.1-19.8 6.1z"/>
          <path id="mMed" d="M98 125c-5.5 0-10-4.5-10-10v-2.2c0-1.2 1-2.2 2.2-2.2h39.6c1.2 0 2.2 1 2.2 2.2v2.2c0 5.5-4.5 10-10 10H98z"/>
          <path id="mLg" d="M110 132c-10.8 0-19.6-8.8-19.6-19.6 0-2.5 2-4.6 4.6-4.6h30c2.5 0 4.6 2 4.6 4.6 0 10.8-8.8 19.6-19.6 19.6z"/>
        </defs>

        <g class="mouth">
          <path class="mouthBG" fill="#617E92" d="M110 121c-7.5 0-14.2-2.3-19.8-6.1a3 3 0 0 1 3.3-5c4.7 3.1 10.4 4.9 16.5 4.9s11.7-1.8 16.5-4.9a3 3 0 0 1 3.3 5c-5.6 3.8-12.3 6.1-19.8 6.1z"/>
          <clipPath id="mouthClip"><use href="#mLg"/></clipPath>
          <g clip-path="url(#mouthClip)">
            <circle class="tongue" cx="110" cy="126" r="9" fill="#cc4a6c"/>
            <ellipse cx="110" cy="118.5" rx="3.2" ry="1.6" fill="#fff" opacity=".12"/>
          </g>
          <path class="tooth" d="M116 116h-5.6c-1.2 0-2.3-1-2.3-2.3v-2.1h10.2v2.1c0 1.3-1 2.3-2.3 2.3z" fill="#fff"/>
        </g>
      </g>
    </svg>

    <!-- Paws (in front of card, half on/half off) -->
    <svg class="bunny-paws" viewBox="0 0 220 88" aria-hidden="true">
      <!-- left paw -->
      <g class="pawL">
        <ellipse cx="76" cy="44" rx="30" ry="20" fill="#fff" stroke="#eaeaea" stroke-width="2"/>
        <g class="twoFingersL">
          <ellipse cx="66" cy="42" rx="7.2" ry="5.2" fill="#ffd6de"/>
          <ellipse cx="86" cy="42" rx="7.2" ry="5.2" fill="#ffd6de"/>
        </g>
      </g>
      <!-- right paw -->
      <g class="pawR">
        <ellipse cx="144" cy="44" rx="30" ry="20" fill="#fff" stroke="#eaeaea" stroke-width="2"/>
        <g class="twoFingersR">
          <ellipse cx="134" cy="42" rx="7.2" ry="5.2" fill="#ffd6de"/>
          <ellipse cx="154" cy="42" rx="7.2" ry="5.2" fill="#ffd6de"/>
        </g>
      </g>
    </svg>

    <div class="ledge-shadow" aria-hidden="true"></div>

    <!-- Login Card -->
    <main class="card auth-wrap">
      <div class="auth-header">
        <h1 class="brand">Pack &amp; Wrap</h1>
        <p class="auth-sub">Welcome back ‚Äî manage your Sales ‚Ä¢ Inventory ‚Ä¢ Profit</p>
      </div>

      <form id="loginForm" class="form vgap" autocomplete="off" novalidate>
        <div class="field">
          <label for="u">User ID</label>
          <input id="u" name="userid" type="text" required autocomplete="username" placeholder="yourid123"/>
          <div class="helper">Use the User ID you chose at signup.</div>
        </div>

        <div class="field">
          <label for="p">Password</label>
          <div class="row">
            <input id="p" name="password" type="password" required autocomplete="current-password" placeholder="Your password"/>
            <button class="btn alt" id="togglePw" type="button" aria-label="Show password">üëÅ</button>
          </div>
        </div>

        <div class="field" style="display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="remember"/>
          <label for="remember">Remember me</label>
        </div>

        <div class="actions">
          <button class="btn primary" id="loginBtn" type="submit">Login</button>
          <div class="divider"><span>or</span></div>
          <div style="text-align:center; font-size:13px; color:var(--muted);">Don‚Äôt have an account?</div>
          <a class="btn alt" href="/signup">Signup</a>
        </div>

        <p id="loginErr" class="err-banner" role="alert" aria-live="assertive"></p>
      </form>
    </main>
  </div>

  <!-- GSAP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.3/TweenMax.min.js"></script>

  <!-- Show/Hide password button + bunny sneak-peek -->
  <script>
    (function(){
      const pw = document.getElementById('p');
      const toggle = document.getElementById('togglePw');
      if (!toggle || !pw) return;

      toggle.addEventListener('click', function(ev){
        ev.preventDefault();
        const wasPassword = pw.type === 'password';
        pw.type = wasPassword ? 'text' : 'password';
        toggle.textContent = wasPassword ? 'üôà' : 'üëÅ';
        toggle.setAttribute('aria-label', wasPassword ? 'Hide password' : 'Show password');
        pw.focus();

        if (window.bunny) {
          if (wasPassword) window.bunny.sneakPeek();  // revealing ‚Üí peek
          else window.bunny.coverEyes();              // hiding ‚Üí cover again
        }
      });
    })();
  </script>

  <!-- Login logic (unchanged) -->
  <script type="module">
    const form = document.getElementById('loginForm');
    const err  = document.getElementById('loginErr');
    const btn  = document.getElementById('loginBtn');
    const pw   = document.getElementById('p');
    const user = document.getElementById('u');
    const remember = document.getElementById('remember');

    user && user.focus();

    function showError(msg){ err.textContent = msg; err.classList.add('show'); }
    function clearError(){ err.textContent = ''; err.classList.remove('show'); }

    let loginUserById = null;
    try {
      const mod = await import('./app.js');
      loginUserById = mod.loginUserById || (mod.default && mod.default.loginUserById) || null;
    } catch (e) { console.error('Failed to import app.js', e); }

    (function(){
      const uid = localStorage.getItem('pw_userId') || sessionStorage.getItem('pw_userId');
      const authed = (localStorage.getItem('pw_authed') === '1') || (sessionStorage.getItem('pw_authed') === '1');
      if (authed && uid) {
        history.replaceState({}, '', `/${encodeURIComponent(uid)}/overview`);
        location.replace('/overview.html');
      }
    })();

    form.addEventListener('submit', async e=>{
      e.preventDefault();
      clearError();

      const userId = (user.value || '').trim();
      const pval   = pw.value || '';
      if(!userId || !pval){ showError('Please enter both User ID and password.'); return; }

      if (typeof loginUserById !== 'function') {
        showError('Login temporarily unavailable (app failed to load). Please refresh the page.');
        return;
      }

      form.classList.add('loading'); btn.textContent = 'Logging in‚Ä¶';
      try{
        const res = await loginUserById(userId, pval);
        if(res && res.ok){
          sessionStorage.setItem('pw_authed','1');
          sessionStorage.setItem('pw_userId', res.userId);
          if(remember.checked){
            localStorage.setItem('pw_authed','1');
            localStorage.setItem('pw_userId', res.userId);
          } else {
            localStorage.removeItem('pw_authed');
            localStorage.removeItem('pw_userId');
          }
          history.replaceState({}, '', `/${encodeURIComponent(res.userId)}/overview`);
          location.replace('/overview.html');
        } else {
          showError('Invalid User ID or password. Please try again.');
        }
      }catch(errEx){
        console.error(errEx);
        showError('Unable to reach the server. Check your connection and try again.');
      } finally {
        form.classList.remove('loading'); btn.textContent = 'Login';
      }
    });
  </script>

  <!-- Bunny animation logic -->
  <script>
    (function(){
      if (typeof TweenMax === 'undefined') return;

      const headBox  = document.querySelector('.bunny-head');
      const pawsBox  = document.querySelector('.bunny-paws');

      const eyeL     = headBox.querySelector('.eyeL');
      const eyeR     = headBox.querySelector('.eyeR');
      const nose     = headBox.querySelector('.nose');
      const mouth    = headBox.querySelector('.mouth');
      const mouthBG  = headBox.querySelector('.mouthBG');
      const mSmall   = headBox.querySelector('#mSmall');
      const mMed     = headBox.querySelector('#mMed');
      const mLg      = headBox.querySelector('#mLg');

      const pawL     = pawsBox.querySelector('.pawL');
      const pawR     = pawsBox.querySelector('.pawR');
      const twoL     = pawsBox.querySelector('.twoFingersL');
      const twoR     = pawsBox.querySelector('.twoFingersR');

      const userInput= document.getElementById('u');
      const password = document.getElementById('p');
      const toggle   = document.getElementById('togglePw');

      if (!headBox || !pawsBox || !userInput) return;

      /* ---------- helpers ---------- */
      function setMouth(p){ if (p) mouthBG.setAttribute('d', p.getAttribute('d')); }
      function pagePos(el){ const r=el.getBoundingClientRect(); return {x:r.left+scrollX,y:r.top+scrollY,w:r.width,h:r.height}; }
      function angle(x1,y1,x2,y2){ return Math.atan2(y1-y2,x1-x2); }

      function trackEyes(){
        const carPos = userInput.selectionEnd ?? userInput.value.length;
        const mirror = document.createElement('div');
        const span   = document.createElement('span');
        const s = getComputedStyle(userInput);
        [].forEach.call(s, (prop)=>mirror.style[prop]=s[prop]);
        mirror.style.position='absolute'; mirror.style.visibility='hidden'; mirror.style.whiteSpace='pre';
        document.body.appendChild(mirror);
        mirror.textContent = userInput.value.substr(0, carPos);
        span.textContent = userInput.value.substr(carPos) || '.';
        mirror.appendChild(span);

        const caret = pagePos(span);
        const hb    = pagePos(headBox);

        const eyeLA = {x: hb.x + hb.w*(88/220), y: hb.y + 24 + hb.h*(100/200)};
        const eyeRA = {x: hb.x + hb.w*(132/220),y: hb.y + 24 + hb.h*(100/200)};
        const noseA = {x: hb.x + hb.w*(110/220),y: hb.y + 24 + hb.h*(114/200)};
        const mouthA= {x: hb.x + hb.w*(110/220),y: hb.y + 24 + hb.h*(121/200)};

        const eLa = angle(eyeLA.x, eyeLA.y, caret.x, caret.y+25);
        const eRa = angle(eyeRA.x, eyeRA.y, caret.x, caret.y+25);
        const nA  = angle(noseA.x, noseA.y, caret.x, caret.y+25);
        const mA  = angle(mouthA.x,mouthA.y, caret.x, caret.y+25);

        const eLX = Math.cos(eLa)*7, eLY = Math.sin(eLa)*5;
        const eRX = Math.cos(eRa)*7, eRY = Math.sin(eRa)*5;
        const nX  = Math.cos(nA)*5,  nY  = Math.sin(nA)*3;
        const mX  = Math.cos(mA)*5,  mY  = Math.sin(mA)*3;
        const mR  = Math.cos(mA)*2;

        TweenMax.to(eyeL,.55,{x:-eLX,y:-eLY,ease:Expo.easeOut});
        TweenMax.to(eyeR,.55,{x:-eRX,y:-eRY,ease:Expo.easeOut});
        TweenMax.to(nose,.55,{x:-nX,y:-nY,rotation:mR,transformOrigin:'center',ease:Expo.easeOut});
        TweenMax.to(mouth,.55,{x:-mX,y:-mY,rotation:mR,transformOrigin:'center',ease:Expo.easeOut});

        document.body.removeChild(mirror);
      }

      function onNameInput(){
        trackEyes();
        const len = userInput.value.length;
        if (len === 0) setMouth(mSmall);
        else if (len < 6) setMouth(mMed);
        else setMouth(mLg);
      }

      /* ---------- paws choreography (calibrated to the eyes) ---------- */
      let covered = false;

      // Rest: paws gripping the ledge, half on/half off the card.
      function pawsRest(){
        TweenMax.to(pawL,.6,{x:0,y:0,rotation:0,transformOrigin:'center',ease:Quad.easeOut});
        TweenMax.to(pawR,.6,{x:0,y:0,rotation:0,transformOrigin:'center',ease:Quad.easeOut,delay:.05});
      }

      // Full cover: both paws up to eye level (fine-tuned for this layout).
      function coverEyes(){
        covered = true;
        // from rest (y‚âà0 in pawsBox), move up ~86px and slightly inward
        TweenMax.to(pawL,.42,{x:-24,y:-86,rotation:-12,ease:Quad.easeOut});
        TweenMax.to(pawR,.42,{x: 24,y:-86,rotation: 12,ease:Quad.easeOut,delay:.05});
        TweenMax.to([twoL,twoR],.22,{y:-1,repeat:1,yoyo:true,ease:Power1.easeInOut});
      }

      // Peek: left still covering, right drops to reveal one eye.
      function sneakPeek(){
        covered = true;
        TweenMax.to(pawL,.34,{x:-24,y:-86,rotation:-12,ease:Quad.easeOut});
        TweenMax.to(pawR,.30,{x: 10,y:-58,rotation: 6, ease:Quad.easeOut});
        TweenMax.to(twoR,.16,{y:-2,repeat:1,yoyo:true});
      }

      function uncoverEyes(){
        covered = false;
        pawsRest();
      }

      // Blink loop
      function blink(delay){
        delay = delay ? Math.floor(Math.random()*delay) : 1;
        TweenMax.to([eyeL, eyeR], .08, {delay:delay, scaleY:.1, yoyo:true, repeat:1, transformOrigin:'center',
          onComplete:function(){ blink(10); }});
      }

      // Pop in on load
      (function init(){
        // head rises from behind the card; paws slide on to grab the ledge
        TweenMax.fromTo(headBox,.85,{y:36,opacity:0},{y:0,opacity:1,ease:Back.easeOut.config(1.4)});
        TweenMax.fromTo(pawsBox,.85,{y:32,opacity:0},{y:0,opacity:1,ease:Back.easeOut.config(1.4),delay:.04});

        // Inputs
        userInput.addEventListener('focus', ()=>{ headBox.classList.add('focused'); onNameInput(); });
        userInput.addEventListener('input', onNameInput);
        userInput.addEventListener('blur',  ()=>{ headBox.classList.remove('focused'); setTimeout(()=>TweenMax.to([eyeL,eyeR,nose,mouth],.5,{x:0,y:0,rotation:0,ease:Expo.easeOut}),120); });

        password.addEventListener('focus', ()=>{
          coverEyes();
          if (password.type === 'text') sneakPeek();
        });
        password.addEventListener('blur',  ()=>{
          setTimeout(()=>{
            const a = document.activeElement;
            if (a !== password && a !== toggle) uncoverEyes();
          },100);
        });
        toggle.addEventListener('focus', ()=>{ coverEyes(); if (password.type === 'text') sneakPeek(); });
        toggle.addEventListener('blur',  ()=>{
          setTimeout(()=>{
            const a = document.activeElement;
            if (a !== password && a !== toggle) uncoverEyes();
          },100);
        });

        // Base pose
        setMouth(mSmall);
        pawsRest();
        blink(5);

        // Expose for the toggle handler
        window.bunny = { coverEyes, uncoverEyes, sneakPeek };
      })();
    })();
  </script>
</body>
</html>
