<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pack & Wrap ‚Ä¢ Login</title>
  <link rel="stylesheet" href="styles.css"/>

  <!-- Pretty URL + 404 fallback handling + root redirect -->
  <script>
    (function () {
      var params = new URLSearchParams(location.search);
      var p = params.get('p');

      // 404 fallback can land here with ?p=/some/pretty/path
      if (p && /^\/[^/]+\/overview$/.test(decodeURIComponent(p))) {
        var pretty = decodeURIComponent(p);
        history.replaceState({}, '', pretty);
        location.replace('/overview.html'); // load the actual file
        return;
      }

      // Decide what to do on root or /login
      var path = location.pathname;
      if (path === '/' || path.endsWith('/index.html') || path.endsWith('/login.html') || (p && decodeURIComponent(p) === '/login')) {
        // If "remembered" (localStorage) OR active tab session, go to overview
        var uid = localStorage.getItem('pw_userId') || sessionStorage.getItem('pw_userId');
        var authed = (localStorage.getItem('pw_authed') === '1') || (sessionStorage.getItem('pw_authed') === '1');

        if (authed && uid) {
          history.replaceState({}, '', `/${encodeURIComponent(uid)}/overview`);
          location.replace('/overview.html');
          return;
        }

        // Otherwise, keep pretty /login
        history.replaceState({}, '', '/login');
      }
    })();
  </script>

  <style>
    /* keep the login card centered */
    body { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:16px; position:relative; }

    /* your existing look for the card/form */
    .auth-wrap{ width:100%; max-width:460px; padding:20px; }
    .auth-header{ text-align:center; margin-bottom:8px; }
    .auth-sub{ color:var(--muted); font-size:14px; margin:0 0 14px; text-align:center; }
    .field{ display:grid; gap:6px; margin-bottom:12px; }
    .field .row{ display:flex; gap:8px; align-items:center; }
    .field .row input{ flex:1; }
    .actions{ display:grid; gap:10px; margin-top:12px; }
    .err-banner{ display:none; margin:12px 0 0; padding:10px 12px; border-radius:12px; border:1px solid #ef4444; background:rgba(239,68,68,.1); color:#fecaca; font-size:14px; }
    .err-banner.show{ display:block; }
    .divider{ display:flex; align-items:center; gap:10px; color:var(--muted); font-size:12px; margin:8px 0; }
    .divider::before,.divider::after{ content:""; height:1px; flex:1; background:var(--border); }
    .loading{ opacity:.7; pointer-events:none; }
    .brand{ font-size:26px; font-weight:900; letter-spacing:.5px; text-align:center; background:linear-gradient(90deg,#fff,#d8b4fe,#f9a8d4); -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:0 2px 8px rgba(0,0,0,.25); }
    .btn.alt{ border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.06); box-shadow:0 6px 18px rgba(196,181,253,.18); }

    /* remove underline for link styled as button */
    a.btn, a.btn:visited { text-decoration: none; }

    /* Avatar wrapper ‚Äî keeps figure inside the circle and matches page background */
    .avatar-wrap{ display:flex; justify-content:center; margin-bottom:10px; }
    .svgContainer{
      position:relative; width:200px; height:200px;
      border-radius:50%;
      overflow:hidden;              /* keep figure inside circle */
      pointer-events:none;          /* avatar never blocks clicks */
      background: transparent;      /* show page background through the hole */
    }
    .svgContainer > div{ position:relative; width:100%; height:100%; }
    .svgContainer .mySVG{
      position:absolute; left:0; top:0; width:100%; height:100%;
      pointer-events:none;
    }

    /* Make the big background circle transparent to match page */
    .mySVG > circle:first-of-type { fill: transparent !important; }

    /* keep eye button clickable above everything */
    #togglePw { position:relative; z-index:5; }
  </style>
</head>

<body>
  <div class="bg-figurines" aria-hidden="true">
    <span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span>
  </div>

  <main class="card auth-wrap" style="z-index:1">
    <div class="auth-header">
      <h1 class="brand">Pack &amp; Wrap</h1>
      <p class="auth-sub">Welcome back ‚Äî manage your Sales ‚Ä¢ Inventory ‚Ä¢ Profit</p>
    </div>

    <!-- Avatar (Bunny) -->
    <div class="avatar-wrap">
      <div class="svgContainer">
        <div>
          <!-- ===== Bunny Avatar SVG ===== -->
          <!-- Uses the same class names your JS already animates: eyeL/eyeR, nose, mouth(+variants), armL/armR, twoFingers, etc. -->
          <svg class="mySVG" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">
            <!-- Mask same as before to clip paws -->
            <defs>
              <circle id="armMaskPath" cx="100" cy="100" r="100"/>
              <clipPath id="armMask"><use href="#armMaskPath"/></clipPath>

              <!-- Mouth paths (kept for compatibility with your morphing code) -->
              <path id="mouthSmall" d="M100.2,101c-0.4,0-1.4,0-1.8,0c-2.7-0.3-5.3-1.1-8-2.5c-0.7-0.3-0.9-1.2-0.6-1.8c0.2-0.5,0.7-0.7,1.2-0.7
               c0.2,0,0.5,0.1,0.6,0.2c3,1.5,5.8,2.3,8.6,2.3s5.7-0.7,8.6-2.3c0.2-0.1,0.4-0.2,0.6-0.2c0.5,0,1,0.3,1.2,0.7
               c0.4,0.7,0.1,1.5-0.6,1.9c-2.6,1.4-5.3,2.2-7.9,2.5C101.7,101,100.5,101,100.2,101z"/>
              <path id="mouthMed" d="M95,104.2c-4.5,0-8.2-3.7-8.2-8.2v-2c0-1.2,1-2.2,2.2-2.2h22c1.2,0,2.2,1,2.2,2.2v2
               c0,4.5-3.7,8.2-8.2,8.2H95z"/>
              <path id="mouthLg" d="M100,110.2c-9,0-16.2-7.3-16.2-16.2c0-2.3,1.9-4.2,4.2-4.2h24c2.3,0,4.2,1.9,4.2,4.2
               c0,9-7.2,16.2-16.2,16.2z"/>
            </defs>

            <!-- Transparent outer circle (kept for CSS override) -->
            <circle cx="100" cy="100" r="100" fill="#ffc0cb"/>

            <!-- Hole -->
            <ellipse cx="100" cy="142" rx="48" ry="18" fill="#d69aa9" opacity=".35"/>

            <!-- Ears -->
            <g class="ears">
              <!-- Left ear -->
              <g transform="translate(68 32)">
                <ellipse cx="0" cy="34" rx="14" ry="38" fill="#ffffff" stroke="#e6e6e6" stroke-width="1.5"/>
                <ellipse cx="0" cy="36" rx="8" ry="28" fill="#f59ab2"/>
              </g>
              <!-- Right ear -->
              <g transform="translate(132 32)">
                <ellipse cx="0" cy="34" rx="14" ry="38" fill="#ffffff" stroke="#e6e6e6" stroke-width="1.5"/>
                <ellipse cx="0" cy="36" rx="8" ry="28" fill="#f59ab2"/>
              </g>
            </g>

            <!-- Head -->
            <g class="head">
              <circle cx="100" cy="106" r="42" fill="#ffffff" stroke="#eaeaea" stroke-width="1.5"/>
              <!-- Eyes your JS will animate -->
              <g class="eyeL">
                <circle cx="86" cy="102" r="6.5" fill="#2a2a2a"/>
                <circle cx="84.7" cy="100.9" r="1.6" fill="#fff"/>
              </g>
              <g class="eyeR">
                <circle cx="114" cy="102" r="6.5" fill="#2a2a2a"/>
                <circle cx="112.7" cy="100.9" r="1.6" fill="#fff"/>
              </g>

              <!-- Nose your JS references -->
              <path class="nose" d="M100 112c3.8 0 6-2.6 4.2-4.3l-3.2-3.2c-1.1-1.1-2.9-1.1-4 0l-3.2 3.2c-1.8 1.7.4 4.3 4.2 4.3z" fill="#ff8ea1"/>

              <!-- Mouth paths kept for compatibility with existing morph code -->
              <g class="mouth">
                <path class="mouthBG" fill="#617E92" opacity=".0001" d="M100.2,101c-0.4,0-1.4,0-1.8,0c-2.7-0.3-5.3-1.1-8-2.5c-0.7-0.3-0.9-1.2-0.6-1.8
                  c0.2-0.5,0.7-0.7,1.2-0.7c0.2,0,0.5,0.1,0.6,0.2c3,1.5,5.8,2.3,8.6,2.3s5.7-0.7,8.6-2.3c0.2-0.1,0.4-0.2,0.6-0.2
                  c0.5,0,1,0.3,1.2,0.7c0.4,0.7,0.1,1.5-0.6,1.9c-2.6,1.4-5.3,2.2-7.9,2.5C101.7,101,100.5,101,100.2,101z"/>
                <path class="mouthSmallBG" style="display:none" fill="#617E92" d="M100.2,101c-0.4,0-1.4,0-1.8,0c-2.7-0.3-5.3-1.1-8-2.5c-0.7-0.3-0.9-1.2-0.6-1.8
                  c0.2-0.5,0.7-0.7,1.2-0.7c0.2,0,0.5,0.1,0.6,0.2c3,1.5,5.8,2.3,8.6,2.3s5.7-0.7,8.6-2.3c0.2-0.1,0.4-0.2,0.6-0.2
                  c0.5,0,1,0.3,1.2,0.7c0.4,0.7,0.1,1.5-0.6,1.9c-2.6,1.4-5.3,2.2-7.9,2.5C101.7,101,100.5,101,100.2,101z"/>
                <path class="mouthMediumBG" style="display:none" d="M95,104.2c-4.5,0-8.2-3.7-8.2-8.2v-2c0-1.2,1-2.2,2.2-2.2h22c1.2,0,2.2,1,2.2,2.2v2
                  c0,4.5-3.7,8.2-8.2,8.2H95z"/>
                <path class="mouthLargeBG" style="display:none" d="M100 110.2c-9 0-16.2-7.3-16.2-16.2 0-2.3 1.9-4.2 4.2-4.2h24c2.3 0 4.2 1.9 4.2 4.2
                  0 9-7.2 16.2-16.2 16.2z" fill="#617e92" stroke="#3a5e77" stroke-linejoin="round" stroke-width="2.5"/>
                <defs>
                  <use id="mouthMaskPath" href="#mouthSmall"/>
                </defs>
              </g>
            </g>

            <!-- Paws (reuse armL/armR class names so existing JS drives them) -->
            <g class="arms" clip-path="url(#armMask)">
              <!-- Left paw -->
              <g class="armL" transform="translate(58,164)">
                <g class="paw">
                  <ellipse cx="0" cy="0" rx="24" ry="14" fill="#ffffff" stroke="#eaeaea" stroke-width="1.2"/>
                  <g class="twoFingers">
                    <ellipse cx="-8" cy="-1" rx="6" ry="4.5" fill="#ffd6de"/>
                    <ellipse cx="8" cy="-1" rx="6" ry="4.5" fill="#ffd6de"/>
                  </g>
                </g>
              </g>

              <!-- Right paw -->
              <g class="armR" transform="translate(142,164)">
                <g class="paw">
                  <ellipse cx="0" cy="0" rx="24" ry="14" fill="#ffffff" stroke="#eaeaea" stroke-width="1.2"/>
                  <g class="twoFingers">
                    <ellipse cx="-8" cy="-1" rx="6" ry="4.5" fill="#ffd6de"/>
                    <ellipse cx="8" cy="-1" rx="6" ry="4.5" fill="#ffd6de"/>
                  </g>
                </g>
              </g>
            </g>
          </svg>
          <!-- ===== end Bunny SVG ===== -->
        </div>
      </div>
    </div>

    <!-- Login form -->
    <form id="loginForm" class="form vgap" autocomplete="off" novalidate>
      <div class="field">
        <label for="u">User ID</label>
        <input id="u" name="userid" type="text" required autocomplete="username" placeholder="yourid123"/>
        <div class="helper">Use the User ID you chose at signup.</div>
      </div>

      <div class="field">
        <label for="p">Password</label>
        <div class="row">
          <input id="p" name="password" type="password" required autocomplete="current-password" placeholder="Your password"/>
          <button class="btn alt" id="togglePw" type="button" aria-label="Show password">üëÅ</button>
        </div>
      </div>

      <div class="field" style="display:flex; align-items:center; gap:8px;">
        <input type="checkbox" id="remember"/>
        <label for="remember">Remember me</label>
      </div>

      <div class="actions">
        <button class="btn primary" id="loginBtn" type="submit">Login</button>
        <div class="divider"><span>or</span></div>
        <div style="text-align:center; font-size:13px; color:var(--muted);">Don‚Äôt have an account?</div>
        <a class="btn alt" href="/signup">Signup</a>
      </div>

      <p id="loginErr" class="err-banner" role="alert" aria-live="assertive"></p>
    </form>
  </main>

  <!-- GSAP for avatar -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.3/TweenMax.min.js"></script>

  <!-- Eye button toggle -->
  <script>
    (function(){
      var pw = document.getElementById('p');
      var toggle = document.getElementById('togglePw');
      if (toggle && pw) {
        toggle.addEventListener('click', function(ev){
          ev.preventDefault();
          var isPw = pw.type === 'password';
          pw.type = isPw ? 'text' : 'password';
          toggle.textContent = isPw ? 'üôà' : 'üëÅ';
          toggle.setAttribute('aria-label', isPw ? 'Hide password' : 'Show password');
          // keep user in password section; paws spread/close
          pw.focus();
          if (window.avatar) {
            if (isPw) window.avatar.spreadFingers();
            else window.avatar.closeFingers();
          }
        });
      }
    })();
  </script>

  <!-- Login logic ‚Äî robust dynamic import + NO optimistic fallback -->
  <script type="module">
    const form = document.getElementById('loginForm');
    const err  = document.getElementById('loginErr');
    const btn  = document.getElementById('loginBtn');
    const pw   = document.getElementById('p');
    const user = document.getElementById('u');
    const remember = document.getElementById('remember');

    user && user.focus();

    function showError(msg){ err.textContent = msg; err.classList.add('show'); }
    function clearError(){ err.textContent = ''; err.classList.remove('show'); }

    // Try to import app.js and get login function
    let loginUserById = null;
    try {
      const mod = await import('./app.js');
      loginUserById = mod.loginUserById || (mod.default && mod.default.loginUserById) || null;
    } catch (e) {
      console.error('Failed to import app.js', e);
    }

    // If already logged in (session or remembered), go straight to overview
    (function(){
      const uid = localStorage.getItem('pw_userId') || sessionStorage.getItem('pw_userId');
      const authed = (localStorage.getItem('pw_authed') === '1') || (sessionStorage.getItem('pw_authed') === '1');
      if (authed && uid) {
        history.replaceState({}, '', `/${encodeURIComponent(uid)}/overview`);
        location.replace('/overview.html'); // absolute
      }
    })();

    form.addEventListener('submit', async e=>{
      e.preventDefault();
      clearError();

      const userId = (user.value || '').trim();
      const pval   = pw.value || '';
      if(!userId || !pval){
        showError('Please enter both User ID and password.');
        return;
      }

      if (typeof loginUserById !== 'function') {
        showError('Login temporarily unavailable (app failed to load). Please refresh the page.');
        return;
      }

      form.classList.add('loading'); btn.textContent = 'Logging in‚Ä¶';
      try{
        const res = await loginUserById(userId, pval);
        if(res && res.ok){
          sessionStorage.setItem('pw_authed','1');
          sessionStorage.setItem('pw_userId', res.userId);

          if(remember.checked){
            localStorage.setItem('pw_authed','1');
            localStorage.setItem('pw_userId', res.userId);
          } else {
            localStorage.removeItem('pw_authed');
            localStorage.removeItem('pw_userId');
          }

          history.replaceState({}, '', `/${encodeURIComponent(res.userId)}/overview`);
          location.replace('/overview.html');
        } else {
          showError('Invalid User ID or password. Please try again.');
        }
      }catch(errEx){
        console.error(errEx);
        showError('Unable to reach the server. Check your connection and try again.');
      } finally {
        form.classList.remove('loading'); btn.textContent = 'Login';
      }
    });
  </script>

  <!-- Bunny Avatar JS (keeps your original animation behavior) -->
  <script>
    (function(){
      if (typeof TweenMax === 'undefined') return;

      var userInput  = document.querySelector('#u'),
          password   = document.querySelector('#p'),
          toggleBtn  = document.querySelector('#togglePw'),
          mySVGBox   = document.querySelector('.svgContainer'),
          mySVG      = document.querySelector('.mySVG'),
          twoFingers = document.querySelectorAll('.twoFingers'),
          armL       = document.querySelector('.armL'),
          armR       = document.querySelector('.armR'),
          eyeL       = document.querySelector('.eyeL'),
          eyeR       = document.querySelector('.eyeR'),
          nose       = document.querySelector('.nose'),
          mouth      = document.querySelector('.mouth'),
          mouthBG    = document.querySelector('.mouthBG'),
          mouthSmall = document.querySelector('.mouthSmallBG'),
          mouthMed   = document.querySelector('.mouthMediumBG'),
          mouthLg    = document.querySelector('.mouthLargeBG'),
          mouthMaskPath = document.querySelector('#mouthMaskPath'),
          mouthOutline  = null, // not used in bunny
          tooth      = null,    // not used in bunny
          tongue     = null,    // not used in bunny
          chin       = null,    // not used
          face       = document.querySelector('.head'),
          eyebrow    = null,    // not used
          outerEarL  = null, outerEarR = null, earHairL = null, earHairR = null,
          hair       = null;

      if (!mySVGBox || !userInput || !eyeL || !eyeR) return;

      function getAngle(x1, y1, x2, y2) { return Math.atan2(y1 - y2, x1 - x2); }
      function getPosition(el){
        var xPos=0,yPos=0;
        while (el){
          if (el.tagName=="BODY"){
            var xScroll = el.scrollLeft || document.documentElement.scrollLeft;
            var yScroll = el.scrollTop  || document.documentElement.scrollTop;
            xPos += (el.offsetLeft - xScroll + el.clientLeft);
            yPos += (el.offsetTop  - yScroll + el.clientTop);
          } else {
            xPos += (el.offsetLeft - el.scrollLeft + el.clientLeft);
            yPos += (el.offsetTop  - el.scrollTop  + el.clientTop);
          }
          el = el.offsetParent;
        }
        return {x:xPos,y:yPos};
      }

      // Mouth path swapping (kept for compatibility with your original code)
      function setMouthFromPath(pathEl) {
        if (!pathEl) return;
        var d = pathEl.getAttribute('d');
        if (d) {
          // mouthBG exists; we just keep it nearly invisible
          mouthBG.setAttribute('d', d);
          // Update the indirection node your code references
          var useEl = document.getElementById('mouthMaskPath');
          if (useEl) useEl.setAttribute('href', '#' + pathEl.getAttribute('class'));
        }
      }
      function mouthSmallState(){ setMouthFromPath(mouthSmall); }
      function mouthMediumState(){ setMouthFromPath(mouthMed); }
      function mouthLargeState(){ setMouthFromPath(mouthLg); }

      function calculateFaceMove(){
        // caret position mirror
        var carPos = userInput.selectionEnd;
        if (carPos == null) carPos = userInput.value.length;

        var div = document.createElement('div'), span = document.createElement('span'),
            copyStyle = getComputedStyle(userInput);
        [].forEach.call(copyStyle, function(prop){ div.style[prop] = copyStyle[prop]; });
        div.style.position = 'absolute';
        div.style.visibility='hidden';
        div.style.whiteSpace='pre';
        document.body.appendChild(div);
        div.textContent = userInput.value.substr(0, carPos);
        span.textContent = userInput.value.substr(carPos) || '.';
        div.appendChild(span);

        var caretAbs = getPosition(span);
        var caretX = caretAbs.x, caretY = caretAbs.y;

        var boxPos = getPosition(mySVGBox);
        var screenCenter = boxPos.x + (mySVGBox.offsetWidth / 2);

        var eyeLCoords = {x: boxPos.x + 86,  y: boxPos.y + 102};
        var eyeRCoords = {x: boxPos.x + 114, y: boxPos.y + 102};
        var noseCoords = {x: boxPos.x + 100, y: boxPos.y + 112};
        var mouthCoords= {x: boxPos.x + 100, y: boxPos.y + 120};

        var dFromC = screenCenter - caretX;
        var eyeLAngle = getAngle(eyeLCoords.x, eyeLCoords.y, caretX, caretY + 25);
        var eyeRAngle = getAngle(eyeRCoords.x, eyeRCoords.y, caretX, caretY + 25);
        var noseAngle = getAngle(noseCoords.x, noseCoords.y, caretX, caretY + 25);
        var mouthAngle= getAngle(mouthCoords.x, mouthCoords.y, caretX, caretY + 25);

        var eyeLX = Math.cos(eyeLAngle) * 8; var eyeLY = Math.sin(eyeLAngle) * 6;
        var eyeRX = Math.cos(eyeRAngle) * 8; var eyeRY = Math.sin(eyeRAngle) * 6;
        var noseX = Math.cos(noseAngle) * 6; var noseY = Math.sin(noseAngle) * 4;
        var mouthX= Math.cos(mouthAngle)* 6; var mouthY= Math.sin(mouthAngle)* 4;
        var mouthR= Math.cos(mouthAngle)* 2;
        var faceX = mouthX * .4; var faceY = mouthY * .4;

        TweenMax.to(eyeL, 0.7, {x:-eyeLX, y:-eyeLY, ease: Expo.easeOut});
        TweenMax.to(eyeR, 0.7, {x:-eyeRX, y:-eyeRY, ease: Expo.easeOut});
        TweenMax.to(nose, 0.7, {x:-noseX, y:-noseY, rotation: mouthR, transformOrigin: "center center", ease: Expo.easeOut});
        TweenMax.to(mouth,0.7, {x:-mouthX, y:-mouthY, rotation: mouthR, transformOrigin: "center center", ease: Expo.easeOut});
        TweenMax.to(face, 0.7, {x:-faceX, y:-faceY, ease: Expo.easeOut});

        document.body.removeChild(div);
      }

      function onUserInput(){
        calculateFaceMove();
        var len = userInput.value.length;
        if (len === 0) mouthSmallState();
        else if (len < 6) mouthMediumState();
        else mouthLargeState();
      }

      // Paws cover eyes on password focus; spread pads when showing password
      var eyesCovered = false;
      function coverEyes(){
        if (eyesCovered) return;
        TweenMax.killTweensOf([armL, armR]);
        TweenMax.to(armL,.45,{x:-25,y:-78,rotation:-10,transformOrigin:"center",ease:Quad.easeOut});
        TweenMax.to(armR,.45,{x: 25,y:-78,rotation: 10,transformOrigin:"center",ease:Quad.easeOut,delay:.05});
        eyesCovered = true;
      }
      function uncoverEyes(){
        if (!eyesCovered) return;
        TweenMax.killTweensOf([armL, armR]);
        TweenMax.to(armL,0.9,{x:0,y:0,rotation:0,ease:Quad.easeOut});
        TweenMax.to(armR,0.9,{x:0,y:0,rotation:0,ease:Quad.easeOut,delay:.05});
        eyesCovered = false;
      }
      function spreadFingers(){
        twoFingers.forEach(tf=>TweenMax.to(tf,.25,{transformOrigin:"center", scaleX:1.2, scaleY:1.2, y:-2, ease:Power2.easeInOut}));
      }
      function closeFingers(){
        twoFingers.forEach(tf=>TweenMax.to(tf,.25,{transformOrigin:"center", scaleX:1, scaleY:1, y:0, ease:Power2.easeInOut}));
      }

      function resetFace(){
        TweenMax.to([eyeL, eyeR],0.6,{x:0,y:0,scaleX:1,scaleY:1,ease:Expo.easeOut});
        TweenMax.to([nose, mouth, face],0.6,{x:0,y:0,rotation:0,ease:Expo.easeOut});
      }

      function startBlinking(delay){
        delay = delay ? Math.floor(Math.random()*delay) : 1;
        TweenMax.to([eyeL, eyeR], .08, {delay:delay, scaleY:0.1, yoyo:true, repeat:1, transformOrigin:"center center",
          onComplete: function(){ startBlinking(10); }});
      }

      // init
      (function init(){
        userInput.addEventListener('focus', ()=>{ onUserInput(); });
        userInput.addEventListener('blur',  ()=>{ setTimeout(resetFace,120); });
        userInput.addEventListener('input', onUserInput);

        password.addEventListener('focus', ()=>{
          coverEyes();
          if (password.type === 'text') spreadFingers(); else closeFingers();
        });
        password.addEventListener('blur',  ()=>{
          setTimeout(()=>{
            const a = document.activeElement;
            if (a !== toggleBtn && a !== password) { uncoverEyes(); }
          },100);
        });
        toggleBtn.addEventListener('focus', ()=>{
          coverEyes();
          if (password.type === 'text') spreadFingers(); else closeFingers();
        });
        toggleBtn.addEventListener('blur',  ()=>{
          setTimeout(()=>{
            const a = document.activeElement;
            if (a !== password && a !== toggleBtn) { uncoverEyes(); }
          },100);
        });

        // Start with paws at rest near hole (subtle bounce-ready)
        TweenMax.set(armL,{x:0,y:0,rotation:0,transformOrigin:"center"});
        TweenMax.set(armR,{x:0,y:0,rotation:0,transformOrigin:"center"});

        mouthSmallState();
        startBlinking(5);

        // expose small api for the eye button
        window.avatar = { spreadFingers, closeFingers };
      })();
    })();
  </script>
</body>
</html>
