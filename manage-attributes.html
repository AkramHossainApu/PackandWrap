<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pack & Wrap • Manage Types & Sizes</title>
  <link rel="stylesheet" href="styles.css"/>

  <!-- Pretty URL 404 fallback: /{userId}/attributes -->
  <script>
    (function () {
      var params = new URLSearchParams(location.search);
      var p = params.get('p');
      if (p && /^\/[^/]+\/attributes$/.test(decodeURIComponent(p))) {
        var pretty = decodeURIComponent(p);
        history.replaceState({}, '', pretty);
        location.replace('/manage-attributes.html');
      }
    })();
  </script>

  <style>
    /* ===== Topbar (exact same as your Overview) ===== */
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(17,24,39,.85), rgba(17,24,39,.65));
      border-bottom:1px solid var(--border);
    }
    .brand-row{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 16px;
    }
    .brand{
      font-weight:900; letter-spacing:.3px; font-size:18px;
      background:linear-gradient(90deg,#fff,#d8b4fe,#f9a8d4);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow:0 2px 8px rgba(0,0,0,.25);
    }
    .chip{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--border); background:rgba(255,255,255,.06);
    }
    .tabs-wrap{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:0 8px 10px 8px;
    }
    .nav-toggle{
      display:none; border:1px solid var(--border); background:rgba(255,255,255,.06);
      padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:6px; border:1px solid var(--border); border-radius:12px;
      background:rgba(255,255,255,.04);
    }
    .tabs a{
      text-decoration:none; padding:8px 12px; border-radius:10px; color:inherit;
      transition:background .15s ease, color .15s ease, transform .15s ease;
    }
    .tabs a:hover{ background:rgba(255,255,255,.08); transform:translateY(-1px); }
    .tabs a[aria-current="page"]{
      background:linear-gradient(90deg,#a78bfa22,#f472b622);
      border:1px solid var(--border);
      font-weight:700;
    }
    .tabs .btn.ghost{ margin-left:4px; }
    @media (max-width:760px){
      .nav-toggle{ display:inline-block; }
      .tabs{ display:none; width:100%; flex-direction:column; }
      .tabs.show{ display:flex; }
      .tabs a, .tabs .btn.ghost{ width:100%; text-align:left; }
      .tabs .btn.ghost{ margin-left:0; }
    }

    /* ===== Page head & layout ===== */
    .page-head{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin:16px 0 12px;
      flex-wrap:wrap;
    }
    .title-wrap{ display:grid; gap:6px; }
    .title-wrap h2{ margin:0; font-size:22px; letter-spacing:.2px; }
    .title-wrap .sub{ margin:0; font-size:13px; color:var(--muted); }
    .back-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .back-actions .btn{ border-radius:12px; padding:8px 12px; }

    /* ===== Grid of cards ===== */
    .grid{
      display:grid; gap:12px; grid-template-columns:repeat(3, minmax(220px,1fr));
    }
    .card{ border-radius:16px; padding:14px; display:grid; gap:10px; }
    .card h3{ margin:0; font-size:16px; color:#e7dff1; }

    /* ===== Add row ===== */
    .add-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .add-row input{
      flex:1; min-width:180px;
      height:40px; border-radius:12px; padding:8px 12px;
      background:rgba(255,255,255,.06); border:1px solid var(--border); color:inherit;
    }
    .add-row .btn{ padding:8px 12px; border-radius:12px; }

    /* ===== List ===== */
    .list{ list-style:none; margin:0; padding:0; display:grid; gap:6px; }
    .item{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border:1px solid var(--border); border-radius:12px; padding:8px 10px;
      background:rgba(255,255,255,.03);
    }
    .item .name{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .item .actions{ display:flex; gap:6px; }
    .icon-btn{
      border:1px solid var(--border); background:rgba(255,255,255,.06);
      border-radius:10px; padding:6px 8px; cursor:pointer;
    }

    /* ===== Mobile ===== */
    @media (max-width:980px){ .grid{ grid-template-columns:repeat(2, minmax(220px,1fr)); } }
    @media (max-width:640px){
      .grid{ grid-template-columns:1fr; }
      .add-row{ flex-direction:column; align-items:stretch; }
      .add-row .btn{ width:100%; }
    }
  </style>
</head>

<body id="page-attributes" class="bg-grad">
  <div class="bg-figurines" aria-hidden="true">
    <span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span>
  </div>

  <!-- ===== Navbar (same as Overview) ===== -->
  <header class="topbar">
    <div class="brand-row">
      <span class="brand">Pack &amp; Wrap</span>
      <span class="chip" id="overallProfitChip">Overall 0 TK</span>
    </div>
    <div class="tabs-wrap">
      <button id="navToggle" class="nav-toggle" type="button">☰ Menu</button>
      <nav class="tabs" id="mainTabs">
        <!-- Absolute hrefs = file fallback; data-route drives pretty URLs -->
        <a href="/overview.html"     data-route="overview"     id="tabOverview">Overview</a>
        <a href="/products.html"     data-route="products"     id="tabProducts" aria-current="page">Products</a>
        <a href="/investments.html"  data-route="investments"  id="tabInvestments">Investments</a>
        <a href="/sales.html"        data-route="sales"        id="tabSales">Sales</a>
        <a href="/customers.html"    data-route="customers"    id="tabCustomers">Customers</a>
        <a href="/boost.html"        data-route="boost"        id="tabBoost">Boost</a>
        <a href="/backup.html"       data-route="backup"       id="tabBackup">Backup</a>
        <a class="btn ghost" href="#" id="logoutBtn">Logout</a>
      </nav>
    </div>
  </header>

  <!-- ===== Content ===== -->
  <main class="container">
    <section class="section">
      <div class="page-head">
        <div class="title-wrap">
          <h2>Manage Types &amp; Sizes</h2>
          <p class="sub">Create and organize product attributes used across your catalog.</p>
        </div>

        <!-- Back to Products -->
        <div class="back-actions">
          <a id="btnBackProducts" class="btn ghost" href="/products.html" data-route="products">← Back to Products</a>
        </div>
      </div>

      <div class="grid">
        <!-- TYPES -->
        <div class="card" id="cardTypes">
          <h3>Types</h3>
          <div class="add-row">
            <input id="inputType" placeholder="New type (e.g., Poly Mailer)"/>
            <button id="btnAddType" class="btn primary">＋ Add Type</button>
          </div>
          <ul id="listTypes" class="list"></ul>
        </div>

        <!-- SIZES -->
        <div class="card" id="cardSizes">
          <h3>Sizes</h3>
          <div class="add-row">
            <input id="inputSize" placeholder="New size (e.g., 10x13)"/>
            <button id="btnAddSize" class="btn primary">＋ Add Size</button>
          </div>
          <ul id="listSizes" class="list"></ul>
        </div>

        <!-- COLORS -->
        <div class="card" id="cardColors">
          <h3>Colors</h3>
          <div class="add-row">
            <input id="inputColor" placeholder="New color (e.g., Black)"/>
            <button id="btnAddColor" class="btn primary">＋ Add Color</button>
          </div>
          <ul id="listColors" class="list"></ul>
        </div>
      </div>
    </section>
  </main>

  <!-- app.js (ES module) -->
  <script type="module">
    import { store } from './app.js';

    // ---------- Auth gate & pretty URL ----------
    const authed = (sessionStorage.getItem('pw_authed') === '1') || (localStorage.getItem('pw_authed') === '1');
    const uid = sessionStorage.getItem('pw_userId') || localStorage.getItem('pw_userId');
    if(!authed || !uid){
      history.replaceState({}, '', '/login');
      location.replace('/index.html');
      throw new Error('Not authed');
    }
    // Keep pretty URL for this page
    const want = `/${encodeURIComponent(uid)}/attributes`;
    if (location.pathname !== want) history.replaceState({}, '', want);

    // ---------- Navbar: wire links for pretty URLs ----------
    (function(){
      const nav = document.getElementById('mainTabs');
      if (!nav) return;
      nav.querySelectorAll('a[data-route]').forEach(a=>{
        const route = a.getAttribute('data-route');
        a.setAttribute('href', `/${route}.html`);     // safe fallback
        a.addEventListener('click', (e)=>{
          if (a.id === 'logoutBtn') return;           // logout handled separately
          e.preventDefault();
          history.replaceState({}, '', `/${encodeURIComponent(uid)}/${route}`);
          location.assign(`/${route}.html`);
        });
      });
    })();

    // ---------- Mobile nav toggle ----------
    (function(){
      const tgl = document.getElementById('navToggle');
      const tabs = document.getElementById('mainTabs');
      if (!tgl || !tabs) return;
      tgl.addEventListener('click', ()=> tabs.classList.toggle('show'));
    })();

    // ---------- Back to Products (pretty URL) ----------
    (function(){
      const back = document.getElementById('btnBackProducts');
      if (!back) return;
      back.addEventListener('click', (e)=>{
        e.preventDefault();
        history.replaceState({}, '', `/${encodeURIComponent(uid)}/products`);
        location.assign('/products.html');
      });
    })();

    // ---------- Attribute lists (Firestore via store helper) ----------
    const $ = s => document.querySelector(s);
    const el = {
      types: $('#listTypes'),
      sizes: $('#listSizes'),
      colors: $('#listColors'),
      inType: $('#inputType'),
      inSize: $('#inputSize'),
      inColor: $('#inputColor'),
      addType: $('#btnAddType'),
      addSize: $('#btnAddSize'),
      addColor: $('#btnAddColor'),
    };
    const sanitize = (s='') => s.trim().replace(/\s+/g,' ').replace(/[<>]/g,'');
    const uniqPush = (arr, v) => {
      const exists = arr.some(x => (x||'').toLowerCase() === v.toLowerCase());
      if (!exists) arr.push(v);
      return arr;
    };

    function renderList(key, values){
      const target = key==='types' ? el.types : key==='sizes' ? el.sizes : el.colors;
      target.innerHTML = '';
      (values||[]).forEach((name, idx)=>{
        const li = document.createElement('li');
        li.className = 'item';
        li.dataset.idx = idx;
        li.innerHTML = `
          <span class="name">${name}</span>
          <span class="actions">
            <button class="icon-btn" data-action="edit" title="Edit">✏️</button>
            <button class="icon-btn" data-action="del" title="Delete">🗑</button>
          </span>
        `;
        target.appendChild(li);
      });
      if(!values || values.length===0){
        const empty = document.createElement('div');
        empty.style.color = 'var(--muted)';
        empty.style.fontSize = '13px';
        empty.textContent = 'No items yet.';
        target.appendChild(empty);
      }
    }

    let model = { types: [], sizes: [], colors: [] };

    const unsubTypes = store.subscribeUserKV(uid, 'types', (val)=>{
      model.types = Array.isArray(val) ? val : (val?.list || []);
      renderList('types', model.types);
    });
    const unsubSizes = store.subscribeUserKV(uid, 'sizes', (val)=>{
      model.sizes = Array.isArray(val) ? val : (val?.list || []);
      renderList('sizes', model.sizes);
    });
    const unsubColors = store.subscribeUserKV(uid, 'colors', (val)=>{
      model.colors = Array.isArray(val) ? val : (val?.list || []);
      renderList('colors', model.colors);
    });

    const save = async (key) => {
      await store.setUserKV(uid, key, model[key] || []);
    };

    el.addType.addEventListener('click', async ()=>{
      const v = sanitize(el.inType.value); if(!v) return;
      uniqPush(model.types, v); el.inType.value = ''; await save('types');
    });
    el.addSize.addEventListener('click', async ()=>{
      const v = sanitize(el.inSize.value); if(!v) return;
      uniqPush(model.sizes, v); el.inSize.value = ''; await save('sizes');
    });
    el.addColor.addEventListener('click', async ()=>{
      const v = sanitize(el.inColor.value); if(!v) return;
      uniqPush(model.colors, v); el.inColor.value = ''; await save('colors');
    });

    [el.inType, el.inSize, el.inColor].forEach((inp)=>{
      inp.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter') {
          e.preventDefault();
          const map = { inputType:'btnAddType', inputSize:'btnAddSize', inputColor:'btnAddColor' };
          document.getElementById(map[inp.id])?.click();
        }
      });
    });

    function wireList(key, root){
      root.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-action]'); if (!btn) return;
        const idx = parseInt(btn.closest('.item')?.dataset.idx, 10); if (Number.isNaN(idx)) return;

        if (btn.dataset.action === 'del'){
          model[key].splice(idx, 1); await save(key); return;
        }
        if (btn.dataset.action === 'edit'){
          const current = model[key][idx];
          const next = prompt('Edit value:', current);
          const v = sanitize(next||''); if (!v) return;
          if (model[key].some((x,i)=> i!==idx && x.toLowerCase()===v.toLowerCase())){
            alert('This value already exists.'); return;
          }
          model[key][idx] = v; await save(key);
        }
      });
    }
    wireList('types', el.types);
    wireList('sizes', el.sizes);
    wireList('colors', el.colors);

    // ---------- Logout ----------
    document.getElementById('logoutBtn')?.addEventListener('click', (e)=>{
      e.preventDefault();
      sessionStorage.removeItem('pw_authed');
      sessionStorage.removeItem('pw_userId');
      localStorage.removeItem('pw_authed');
      localStorage.removeItem('pw_userId');
      history.replaceState({}, '', '/login');
      location.replace('/index.html');
    });

    // Cleanup
    window.addEventListener('beforeunload', ()=>{
      unsubTypes && unsubTypes(); unsubSizes && unsubSizes(); unsubColors && unsubColors();
    });
  </script>
</body>
</html>
