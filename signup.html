<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pack & Wrap ‚Ä¢ Sign Up</title>
  <link rel="stylesheet" href="styles.css"/>

  <!-- Force pretty URL early -->
  <script>
    (function(){
      var base = location.origin;
      var path = location.pathname;
      if (path.endsWith("/signup.html")) {
        history.replaceState({}, "", base + "/signup");
      }
    })();
  </script>

  <style>
    body { min-height: 100vh; display:flex; align-items:center; justify-content:center; padding:16px; position:relative; }
    .auth-wrap{ width:100%; max-width:480px; padding:20px; }
    .auth-header{ text-align:center; margin-bottom:8px; }
    .auth-sub{ color:var(--muted); font-size:14px; margin:0 0 14px; text-align:center; }
    .field{ display:grid; gap:6px; margin-bottom:12px; }
    .field .row{ display:flex; gap:8px; align-items:center; }
    .field .row input{ flex:1; }
    .helper{ color:var(--muted); font-size:12px; margin-top:2px; }
    .actions{ display:grid; gap:10px; margin-top:12px; }
    .err-banner, .ok-banner{ display:none; margin:12px 0 0; padding:10px 12px; border-radius:12px; font-size:14px; }
    .err-banner{ border:1px solid #ef4444; background:rgba(239,68,68,.1); color:#fecaca; }
    .ok-banner{ border:1px solid #16a34a; background:rgba(34,197,94,.1); color:#86efac; }
    .err-banner.show, .ok-banner.show{ display:block; }
    .avail-msg{ font-size:12px; margin-top:2px; }
    .avail-ok{ color:#22c55e; }
    .avail-bad{ color:#ef4444; }
    .hidden{ display:none; }
    .btn.alt { border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.06); box-shadow:0 6px 18px rgba(196,181,253,.18); }
  </style>
</head>

<body>
  <div class="bg-figurines" aria-hidden="true">
    <span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span>
  </div>

  <main class="card auth-wrap" style="z-index:1">
    <div class="auth-header">
      <h1 class="brand">Pack &amp; Wrap</h1>
      <p class="auth-sub">Create your account.</p>
    </div>

    <form id="signupForm" class="form vgap" autocomplete="off" novalidate>
      <div class="field">
        <label for="su">Username</label>
        <input id="su" type="text" required autocomplete="username" placeholder="Choose a username"/>
        <div class="helper">Allowed: letters, numbers, dot (.), dash (-), underscore (_). We‚Äôll suggest a unique ID.</div>
      </div>

      <div class="field hidden" id="uidField">
        <label for="uid">User ID</label>
        <input id="uid" type="text" required placeholder="Unique ID"/>
        <div id="uidMsg" class="avail-msg"></div>
      </div>

      <div class="field">
        <label for="sp">Password</label>
        <div class="row">
          <input id="sp" type="password" required autocomplete="new-password" placeholder="Create a strong password"/>
          <button class="btn alt" id="togglePw" type="button" aria-label="Show password">üëÅ</button>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="signupBtn" type="submit">Sign Up</button>
        <div class="divider"><span>or</span></div>
        <!-- Use pretty route (no .html) -->
        <a class="btn alt" href="/login" id="loginLink">Login</a>
      </div>

      <p id="signupErr" class="err-banner" role="alert" aria-live="assertive"></p>
      <p id="signupOk" class="ok-banner" role="status" aria-live="polite"></p>
    </form>
  </main>

  <script type="module">
    import { db, addUser } from './app.js';
    import { getDoc, doc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const form = document.getElementById('signupForm');
    const u = document.getElementById('su');
    const uidField = document.getElementById('uidField');
    const uid = document.getElementById('uid');
    const p = document.getElementById('sp');
    const btn = document.getElementById('signupBtn');
    const err = document.getElementById('signupErr');
    const ok  = document.getElementById('signupOk');
    const toggle = document.getElementById('togglePw');
    const uidMsg = document.getElementById('uidMsg');

    const sanitize = s => (s||'').toLowerCase().trim().replace(/\s+/g, '').replace(/[^a-z0-9._-]/g,'');

    function showErr(msg){ err.textContent = msg; err.classList.add('show'); ok.classList.remove('show'); }
    function showOk(msg){ ok.textContent = msg; ok.classList.add('show'); err.classList.remove('show'); }
    function clearBanners(){ err.classList.remove('show'); ok.classList.remove('show'); }

    toggle.addEventListener('click', ()=>{
      const isPw = p.type === 'password';
      p.type = isPw ? 'text' : 'password';
      toggle.textContent = isPw ? 'üôà' : 'üëÅ';
      toggle.setAttribute('aria-label', isPw ? 'Hide password' : 'Show password');
      p.focus();
    });

    async function isAvailable(id){
      try {
        const s = await getDoc(doc(db, "users", id));
        if (s.exists()){
          uidMsg.textContent = "‚ùå User ID is not available";
          uidMsg.className = "avail-msg avail-bad";
          return false;
        } else {
          uidMsg.textContent = "‚úÖ User ID is available";
          uidMsg.className = "avail-msg avail-ok";
          return true;
        }
      } catch (e) {
        console.error('Availability check failed:', e);
        uidMsg.textContent = "‚ö†Ô∏è Unable to verify availability right now";
        uidMsg.className = "avail-msg";
        return true;
      }
    }

    function debounce(fn, ms=120){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
    const updateId = debounce(async ()=>{
      const base = sanitize(u.value);
      if(!base){
        uidField.classList.add('hidden'); uid.value=''; uidMsg.textContent=''; uidMsg.className='avail-msg';
        return;
      }
      uidField.classList.remove('hidden');

      let candidate = base, suffix = 0;
      while(true){
        try{
          const s = await getDoc(doc(db, "users", candidate));
          if(!s.exists()){
            uid.value = candidate;
            await isAvailable(candidate);
            break;
          }
        }catch(e){
          uid.value = candidate;
          await isAvailable(candidate);
          break;
        }
        suffix++; candidate = base + String(suffix);
      }
    }, 80);

    u.addEventListener('input', updateId);
    uid.addEventListener('input', ()=>{ uid.value = sanitize(uid.value); isAvailable(uid.value); });

    form.addEventListener('submit', async e=>{
      e.preventDefault(); clearBanners();
      const username = u.value.trim();
      const userId   = sanitize(uid.value);
      const pass     = p.value;

      if(!username){ showErr('Please enter a username.'); return; }
      if(!userId){ showErr('Please enter a User ID.'); return; }
      if(!pass || pass.length < 6){ showErr('Password must be at least 6 characters.'); return; }

      form.classList.add('loading'); btn.textContent='Creating‚Ä¶';
      try{
        const okAvail = await isAvailable(userId);
        if(!okAvail){ showErr('That User ID is not available. Try the suggested one.'); }
        else {
          await addUser(username, pass, userId);
          showOk('Account created! You can now log in.');
          u.value=''; uid.value=''; p.value=''; uidMsg.textContent=''; uidField.classList.add('hidden');
        }
      }catch(e){
        console.error(e);
        showErr(e?.message || 'Could not create account.');
      }finally{
        form.classList.remove('loading'); btn.textContent='Sign Up';
      }
    });
  </script>
</body>
</html>
