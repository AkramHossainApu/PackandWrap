<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pack & Wrap • Products</title>
  <link rel="stylesheet" href="styles.css"/>

  <!-- Pretty URL + 404 fallback handling -->
  <script>
    (function () {
      // Handle 404 fallback that may land here with ?p=/some/pretty/path
      var params = new URLSearchParams(location.search);
      var p = params.get('p');
      if (p && /^\/[^/]+\/products$/.test(decodeURIComponent(p))) {
        var pretty = decodeURIComponent(p);
        history.replaceState({}, '', pretty);
        // load the actual file
        location.replace('/products.html');
      }
    })();
  </script>

  <style>
    /* -----------------------------
       Products (page-specific polish)
       ----------------------------- */
    .page-head{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px; margin-bottom:12px;
      flex-wrap:wrap;
    }
    .page-head h2{ margin:0; font-size:22px; }
    .page-head .sub{ margin:0; font-size:13px; color:var(--muted); }

    /* Toolbar overrides for this page */
    .toolbar{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
      margin-bottom:14px; --toolbar-h:64px;
    }
    .toolbar input{ flex:1; min-width:220px; }
    .toolbar .actions{ display:flex; gap:8px; flex-wrap:wrap; }

    /* Table headings context */
    .catalog-title{ margin:4px 0 10px; font-size:16px; font-weight:600; color:#e7dff1; }

    /* Responsive tweaks */
    @media(max-width:760px){
      .toolbar{ flex-direction:column; align-items:stretch; }
      .toolbar .actions{ justify-content:space-between; width:100%; }
      .catalog-title{ text-align:center; }
    }
  </style>
</head>

<body id="page-products" class="bg-grad">

  <!-- Floating figurines background -->
  <div class="bg-figurines" aria-hidden="true">
    <span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span>
  </div>

  <!-- Navbar -->
  <header class="topbar">
    <div class="brand-row">
      <span class="brand">Pack &amp; Wrap</span>
      <span class="chip" id="overallProfitChip">Overall 0 TK</span>
    </div>

    <div class="tabs-wrap">
      <button id="navToggle" class="nav-toggle" type="button">☰ Menu</button>
      <nav class="tabs" id="mainTabs">
        <a data-page="overview"  href="overview.html">Overview</a>
        <a data-page="products"  href="products.html" aria-current="page" id="productsTab">Products</a>
        <a data-page="investments" href="investments.html">Investments</a>
        <a data-page="sales"      href="sales.html">Sales</a>
        <a data-page="customers"  href="customers.html">Customers</a>
        <a data-page="boost"      href="boost.html">Boost</a>
        <a data-page="backup"     href="backup.html">Backup</a>
        <a class="btn ghost" href="#" id="logoutBtn">Logout</a>
      </nav>
    </div>
  </header>

  <!-- Content -->
  <main class="container">
    <section class="section">
      <div class="page-head">
        <div>
          <h2>Products</h2>
          <p class="sub">Manage your catalog, pricing, and stock levels.</p>
        </div>
      </div>

      <div class="card">
        <!-- Toolbar -->
        <div class="toolbar">
          <input id="productSearch" placeholder="Search type, size, or color…" />
          <div class="actions">
            <a data-page="manage-attributes" href="manage-attributes.html" class="btn ghost">⚙ Manage Types &amp; Sizes</a>
            <button id="btnAddProduct" class="btn primary">➕ Add New Product</button>
          </div>
        </div>

        <div class="catalog-title">Catalog</div>

        <!-- Products table -->
        <div class="table-wrap">
          <table class="table" id="productTable">
            <thead>
              <tr>
                <th>Size</th>
                <th>Buy (1)</th>
                <th>Sell (1)</th>
                <th>Lowest</th>
                <th>Status</th>
                <th style="min-width:260px">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Use module app.js so Firebase works -->
  <script type="module">
    import { currentUserId, prettyFor } from './app.js';

    // ---------- Auth gate & pretty URL ----------
    (function(){
      const authed = (sessionStorage.getItem('pw_authed') === '1') || (localStorage.getItem('pw_authed') === '1');
      const uid = currentUserId();

      if(!authed || !uid){
        history.replaceState({}, '', '/login');
        location.replace('index.html');
        return;
      }

      const want = prettyFor(uid, 'products');
      if (location.pathname !== want) {
        history.replaceState({}, '', want);
      }
    })();

    // ---------- Pretty-URL navigation wiring (no more self-reloads) ----------
    (function(){
      const uid = currentUserId();
      const tabs = document.getElementById('mainTabs');
      if (!tabs || !uid) return;

      tabs.querySelectorAll('a[data-page]').forEach(a=>{
        a.addEventListener('click', (e)=>{
          e.preventDefault();
          const page = a.getAttribute('data-page');       // e.g. "products"
          const file = a.getAttribute('href');            // e.g. "products.html"
          history.replaceState({}, '', `/${encodeURIComponent(uid)}/${page}`);
          location.href = file;                           // load the real file
        });
      });
    })();

    // ---------- Logout (forget both storages) ----------
    document.getElementById('logoutBtn')?.addEventListener('click', (e)=>{
      e.preventDefault();
      sessionStorage.removeItem('pw_authed');
      sessionStorage.removeItem('pw_userId');
      localStorage.removeItem('pw_authed');
      localStorage.removeItem('pw_userId');
      history.replaceState({}, '', '/login');
      location.replace('index.html');
    });

    // (Your existing product JS / Firebase hooks continue as-is)
  </script>
</body>
</html>
